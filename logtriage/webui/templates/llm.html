{% extends "base.html" %}
{% block content %}
<style>
  .log-line { display:flex; align-items:flex-start; gap:0.55rem; padding:0.1rem 0; }
  .log-line input[type="checkbox"] { margin-top:0.15rem; }
  .log-line.selected { background:#182233; border-radius:0.4rem; padding:0.25rem 0.2rem; }
  .log-section { border:1px solid #222a38; border-radius:0.65rem; margin-bottom:0.75rem; overflow:hidden; }
  .log-section-header { display:flex; gap:0.5rem; align-items:center; justify-content:space-between; padding:0.45rem 0.5rem; background:#111520; border-bottom:1px solid #1f2530; }
  .log-section-body { padding:0.35rem 0.45rem; display:flex; flex-direction:column; gap:0.1rem; }
  .log-section.collapsed .log-section-body { display:none; }
  .log-section .section-actions { display:flex; gap:0.35rem; align-items:center; flex-wrap:wrap; }
  .log-section.highlighted-finding { border-color:#4f6fa9; box-shadow:0 0 0 1px #4f6fa9; }
  .llm-response-box { border:1px solid #2b3242; border-radius:0.65rem; padding:0.65rem; background:#0f131b; min-height:140px; white-space:pre-wrap; }
  .llm-console { display:flex; flex-direction:column; gap:0.65rem; }
  .llm-console textarea { width:100%; min-height:140px; font-family:monospace; }
  .finding-response { border:1px solid #222a38; border-radius:0.65rem; padding:0.6rem; background:#0f131b; display:flex; flex-direction:column; gap:0.35rem; }
  .finding-response + .finding-response { margin-top:0.65rem; }
  .finding-response h4 { margin:0; font-size:1rem; display:flex; gap:0.4rem; align-items:center; flex-wrap:wrap; }
  .finding-response .llm-body { max-height:180px; overflow:auto; background:#0c1018; padding:0.5rem; border-radius:0.5rem; white-space:pre-wrap; }
  .workbench { margin-top:1rem; border:1px solid #222a38; border-radius:0.75rem; padding:0.85rem; background:#0c111a; display:flex; flex-direction:column; gap:0.75rem; }
  .prompt-grid { grid-template-columns: 1.1fr 0.9fr; gap:0.85rem; align-items:stretch; }
  .prompt-grid textarea { min-height:200px; }
  .llm-fixed-response { border:1px solid #2b3242; border-radius:0.65rem; background:#0f131b; padding:0.65rem; height:240px; overflow-y:auto; white-space:pre-wrap; }
  .workbench-actions { display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center; justify-content:space-between; }
  .workbench-actions .left-actions, .workbench-actions .right-actions { display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center; }
  .line-action { border:1px solid #2b3242; background:transparent; color:#e8ecf2; padding:0.15rem 0.4rem; border-radius:0.35rem; cursor:pointer; font-size:0.85rem; }
</style>
<div class="card">
  <h2>Ask LLM</h2>
  <p class="helper-text">Browse the current log tail, view stored LLM answers per finding, and craft prompts without leaving the page.</p>
  {% if message %}
    <div class="helper-text" style="margin:0.35rem 0; padding:0.4rem 0.6rem; border:1px solid #2e4735; background:#142018; color:#b7e6c5; border-radius:0.5rem;">{{ message }}</div>
  {% endif %}
  {% if error %}
    <div class="helper-text" style="margin:0.35rem 0; padding:0.4rem 0.6rem; border:1px solid #5c2f2f; background:#1c1114; color:#ffcdd2; border-radius:0.5rem;">{{ error }}</div>
  {% endif %}
  <form method="get" action="{{ url_for('llm_responses') }}" style="margin-bottom:0.75rem; display:flex; gap:0.75rem; flex-wrap:wrap; align-items:center;">
    <label>Module:
      <select name="module" onchange="this.form.submit()">
        {% for m in modules %}
          <option value="{{ m.name }}" {% if current_module and m.name == current_module.name %}selected{% endif %}>{{ m.name }}</option>
        {% endfor %}
      </select>
    </label>
    <label>Tail view:
      <select name="tail_filter" onchange="this.form.submit()">
        <option value="all" {% if tail_filter == 'ALL' %}selected{% endif %}>All lines</option>
        {% for sev in tail_severities %}
          <option value="{{ sev }}" {% if tail_filter == sev %}selected{% endif %}>{{ sev }} only</option>
        {% endfor %}
      </select>
    </label>
    <label>Issues:
      <select name="issue_filter" onchange="this.form.submit()">
        <option value="all" {% if issue_filter == 'ALL' %}selected{% endif %}>All</option>
        <option value="active" {% if issue_filter == 'ACTIVE' %}selected{% endif %}>Active</option>
        <option value="addressed" {% if issue_filter == 'ADDRESSED' %}selected{% endif %}>Addressed</option>
      </select>
    </label>
    <label>Sample:
      <select name="sample_source" onchange="this.form.submit()">
        <option value="tail" {% if sample_source == 'tail' %}selected{% endif %}>Raw tail</option>
        <option value="errors" {% if sample_source == 'errors' %}selected{% endif %}>Only finding spans</option>
      </select>
    </label>
    <span class="muted">Path: {{ current_module.path if current_module else '-' }}</span>
  </form>

  {% if not modules %}
    <p class="muted">No modules configured yet.</p>
  {% elif not current_module %}
    <p class="muted">Select a module to view its logs.</p>
  {% else %}
    <div class="grid" style="gap:1.25rem; grid-template-columns: 1.35fr 1fr; align-items:start;">
      <div>
        <h3>Log tail</h3>
        {% if sample_lines %}
          <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:0.35rem;">
            <button type="button" class="secondary" onclick="copyAllLines()">Copy all lines</button>
            <button type="button" class="secondary" onclick="copySelectedLines()">Copy selected lines</button>
            <button type="button" class="secondary" onclick="appendSelectedToPrompt()">Append selected to prompt</button>
            <button type="button" class="secondary" onclick="toggleAllFindings()" id="toggle-all-findings">Collapse findings</button>
            {% if tail_filter != 'ALL' %}
              <a href="{{ url_for('llm_responses') }}?module={{ current_module.name }}{% if issue_filter %}&issue_filter={{ issue_filter|lower }}{% endif %}&sample_source={{ sample_source }}" style="display:inline-flex; align-items:center; padding:0.45rem 0.65rem; border:1px solid #2b3242; border-radius:0.35rem; text-decoration:none; color:#e8ecf2;">Reset tail filter</a>
            {% endif %}
            {% if issue_filter != 'ALL' %}
              <a href="{{ url_for('llm_responses') }}?module={{ current_module.name }}{% if tail_filter %}&tail_filter={{ tail_filter|lower }}{% endif %}&sample_source={{ sample_source }}" style="display:inline-flex; align-items:center; padding:0.45rem 0.65rem; border:1px solid #2b3242; border-radius:0.35rem; text-decoration:none; color:#e8ecf2;">Reset issue filter</a>
            {% endif %}
          </div>
          <div id="log-lines" style="max-height:520px; overflow:auto; border:1px solid #222a38; border-radius:0.65rem; padding:0.5rem; background:#0f131b;">
            {% if finding_tail %}
              {% for section in finding_tail %}
                <div class="log-section" {% if section.finding %}data-finding-section="true" data-finding-id="{{ section.finding.id }}" data-finding-index="{{ section.finding.finding_index }}"{% endif %}>
                  <div class="log-section-header">
                    {% if section.finding %}
                      <div style="display:flex; gap:0.4rem; align-items:center; flex-wrap:wrap;">
                        <span class="status-badge sev-{{ section.finding.severity }}">{{ section.finding.severity }}</span>
                        <span class="muted" style="font-size:0.85rem;">Finding #{{ section.finding.finding_index }} · {{ section.finding.created_at|localtime }}</span>
                      </div>
                      <div class="section-actions" style="flex:1; justify-content:flex-end;">
                        <div class="helper-text" style="text-align:right;">{{ section.finding.reason }}</div>
                        <button type="button" class="secondary" data-section-index="{{ loop.index0 }}" onclick="toggleSection(this)">Collapse</button>
                        <button type="button" class="secondary" onclick='loadForLLM({{ finding_examples.get(section.finding.id,section.finding.reason)|tojson }})'>Append to prompt</button>
                      </div>
                    {% else %}
                      <div class="muted">Tail lines</div>
                    {% endif %}
                  </div>
                  <div class="log-section-body">
                    {% for line in section.lines %}
                      <div class="log-line" style="font-family:monospace; font-size:0.92rem;" data-line-index="{{ line.index }}">
                        <input type="checkbox" name="selected_line" value="{{ line.index }}" data-line="{{ line.text|replace('\n','')|e }}">
                        <span style="min-width:3.25rem; color:#9fb1d3;">{{ "%4d" % line.index }}:</span>
                        <span style="flex:1; white-space:pre-wrap; word-break:break-word;">{{ line.text }}</span>
                        <button type="button" class="line-action" data-line-text="{{ line.text|replace('\n','')|e }}" onclick="appendLineToPrompt(this)">Add</button>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            {% elif had_finding_tail and (tail_filter != 'ALL' or issue_filter != 'ALL') %}
              <p class="muted">No sections matched the current filters.</p>
            {% else %}
              {% for line in sample_lines %}
                <div class="log-line" style="font-family:monospace; font-size:0.92rem;">
                  <input type="checkbox" name="selected_line" data-line="{{ line|replace('\n','')|e }}">
                  <span style="flex:1; white-space:pre-wrap; word-break:break-word;">{{ line }}</span>
                  <button type="button" class="line-action" data-line-text="{{ line|replace('\n','')|e }}" onclick="appendLineToPrompt(this)">Add</button>
                </div>
              {% endfor %}
            {% endif %}
          </div>
        {% else %}
          <p class="muted">No lines read from this log path.</p>
        {% endif %}
      </div>
      <div class="grid" style="gap:1rem;">
        <div>
          <h3>Finding LLM responses</h3>
          {% if not db_status.connected %}
            <p class="muted">Database not connected; start the log-triage process with database.url configured to see finding history.</p>
          {% elif not recent_findings %}
            <p class="muted">No findings recorded yet for this module.</p>
          {% else %}
            <div style="max-height:520px; overflow:auto; border:1px solid #222a38; border-radius:0.65rem; padding:0.5rem; background:#0f131b;">
              {% for c in recent_findings %}
                {% set response_obj = c|attr('llm_response') %}
                {% set response_content = response_obj.content if response_obj else c|attr('llm_response_content') %}
                <div class="finding-response" data-finding-summary="true" data-finding-id="{{ c.id }}">
                  <h4>
                    <span class="status-badge sev-{{ c.severity }}">{{ c.severity }}</span>
                    <span style="font-size:0.9rem; color:#9fb1d3;">{{ c.created_at|localtime }}</span>
                    <span class="muted">#{{ c.finding_index }}</span>
                  </h4>
                  <div class="helper-text">{{ c.reason }}</div>
                  {% if response_content %}
                    <div class="llm-body">{{ response_content }}</div>
                  {% else %}
                    <p class="muted">No stored LLM response for this finding yet.</p>
                  {% endif %}
                  <div class="recorded-summary muted" data-summary-for="{{ c.id }}" style="display:none;"></div>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    {% if providers %}
    <div class="workbench">
      <div class="workbench-actions">
        <div class="left-actions">
          <label>Provider
            <select id="llm-provider">
              {% for p in providers %}
                <option value="{{ p.name }}" {% if selected_provider and p.name == selected_provider %}selected{% endif %}>{{ p.name }} ({{ p.model }})</option>
              {% endfor %}
            </select>
          </label>
          <div id="provider-hints" class="helper-text"></div>
        </div>
        <div class="right-actions">
          <label>Attach to finding
            <select id="finding-selector">
              <option value="">Select finding (optional)</option>
              {% for c in recent_findings %}
                <option value="{{ c.id }}">#{{ c.finding_index }} · {{ c.created_at|localtime }}</option>
              {% endfor %}
            </select>
          </label>
        </div>
      </div>
      <div class="grid prompt-grid">
        <div>
          <label>Prompt builder
            <textarea id="llm-prompt" placeholder="{{ 'Paste lines or append from the log tail' }}">{{ seed_prompt or '' }}</textarea>
          </label>
          <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-top:0.35rem;">
            <button type="button" onclick="sendLLMPrompt()">Send to LLM</button>
            <button type="button" class="secondary" onclick="clearPrompt()">Clear</button>
            <button type="button" class="secondary" onclick="loadPredefinedPrompt()" {% if not module_prompt_template %}disabled{% endif %}>Load predefined prompt</button>
            <span id="llm-status" class="muted"></span>
          </div>
        </div>
        <div>
          <label>LLM answers
            <div id="llm-response" class="llm-fixed-response muted">No LLM response yet.</div>
          </label>
          <div id="llm-usage" class="helper-text" style="margin-top:0.25rem;"></div>
          <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-top:0.35rem;">
            <button type="button" class="secondary" onclick="summarizeAndRecord()">Summarize & record for finding</button>
          </div>
        </div>
      </div>
    </div>
    {% else %}
      <p class="muted">No providers configured. Update config.yaml to add entries under llm.providers.</p>
    {% endif %}
  {% endif %}
</div>

<script>
  const sampleLines = {{ sample_lines|tojson }};
  const providerSettings = {{ provider_settings|tojson }};
  const modulePromptTemplate = {{ module_prompt_template|tojson }};
  const recordedSummaries = {};

  function copyText(text) {
    if (!navigator.clipboard) {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    } else {
      navigator.clipboard.writeText(text);
    }
  }

  function copyAllLines() {
    copyText(sampleLines.join('\n'));
  }

  function copySelectedLines() {
    const selected = Array.from(document.querySelectorAll('input[name="selected_line"]:checked'))
      .map(cb => cb.dataset.line)
      .filter(Boolean);
    copyText(selected.join('\n'));
  }

  function appendSelectedToPrompt() {
    const selected = Array.from(document.querySelectorAll('input[name="selected_line"]:checked'))
      .map(cb => cb.dataset.line)
      .filter(Boolean);
    if (!selected.length) return;
    appendToPrompt(selected.join('\n'));
  }

  function appendLineToPrompt(btn) {
    const text = btn?.dataset?.lineText;
    appendToPrompt(text);
  }

  function appendToPrompt(text) {
    const prompt = document.getElementById('llm-prompt');
    if (!prompt || !text) return;
    prompt.value = prompt.value ? `${prompt.value}\n${text}` : text;
    prompt.focus();
  }

  function refreshSelectedHighlights() {
    document.querySelectorAll('.log-line').forEach(row => {
      const cb = row.querySelector('input[name="selected_line"]');
      row.classList.toggle('selected', cb && cb.checked);
    });
  }

  document.querySelectorAll('input[name="selected_line"]').forEach(cb => {
    cb.addEventListener('change', refreshSelectedHighlights);
  });
  refreshSelectedHighlights();

  function toggleSection(btn) {
    const idx = btn.dataset.sectionIndex;
    const sections = document.querySelectorAll('.log-section');
    const section = sections[idx];
    if (section) {
      section.classList.toggle('collapsed');
      btn.textContent = section.classList.contains('collapsed') ? 'Expand' : 'Collapse';
    }
  }

  function toggleAllFindings() {
    const sections = document.querySelectorAll('.log-section[data-finding-section="true"]');
    const allCollapsed = Array.from(sections).every(sec => !sec.classList.contains('collapsed'));
    sections.forEach(sec => {
      sec.classList.toggle('collapsed', allCollapsed);
    });
    const btn = document.getElementById('toggle-all-findings');
    if (btn) {
      btn.textContent = allCollapsed ? 'Expand findings' : 'Collapse findings';
    }
  }

  function loadForLLM(text) {
    appendToPrompt(text);
  }

  function clearPrompt() {
    const prompt = document.getElementById('llm-prompt');
    if (prompt) {
      prompt.value = '';
      prompt.focus();
    }
    const status = document.getElementById('llm-status');
    if (status) status.textContent = '';
    const resp = document.getElementById('llm-response');
    if (resp) resp.textContent = 'No LLM response yet.';
    const usage = document.getElementById('llm-usage');
    if (usage) usage.textContent = '';
  }

  function loadPredefinedPrompt() {
    if (!modulePromptTemplate) return;
    const prompt = document.getElementById('llm-prompt');
    if (!prompt) return;
    prompt.value = modulePromptTemplate;
    prompt.focus();
  }

  function updateProviderHints() {
    const select = document.getElementById('llm-provider');
    const hints = document.getElementById('provider-hints');
    if (!select || !hints) return;
    const cfg = providerSettings[select.value];
    if (!cfg) {
      hints.textContent = '';
      return;
    }
    hints.textContent = `max_excerpt_lines ${cfg.max_excerpt_lines}, max_tokens ${cfg.max_output_tokens}, temp ${cfg.temperature}, top_p ${cfg.top_p}`;
  }

  async function callLLM(promptText) {
    const provider = document.getElementById('llm-provider');
    const status = document.getElementById('llm-status');
    const respBox = document.getElementById('llm-response');
    const usage = document.getElementById('llm-usage');
    if (!provider || !respBox) return null;

    if (!promptText) {
      if (status) status.textContent = 'Enter a prompt to query the LLM.';
      return null;
    }

    if (status) status.textContent = 'Sending...';
    respBox.textContent = '';
    if (usage) usage.textContent = '';

    const formData = new FormData();
    formData.append('provider', provider.value);
    formData.append('prompt', promptText);

    let responseData;
    try {
      const resp = await fetch('{{ url_for('llm_query') }}', { method: 'POST', body: formData });
      responseData = await resp.json();
      if (!resp.ok) {
        throw new Error(responseData.error || 'Request failed');
      }
    } catch (err) {
      if (status) status.textContent = err.message || 'Failed to reach LLM provider';
      respBox.textContent = '';
      return null;
    }

    if (status) status.textContent = `Response from ${responseData.provider} (${responseData.model})`;
    respBox.textContent = responseData.content || '(empty response)';
    if (responseData.usage && (responseData.usage.prompt_tokens || responseData.usage.completion_tokens)) {
      if (usage) usage.textContent = `prompt_tokens: ${responseData.usage.prompt_tokens || 'n/a'}, completion_tokens: ${responseData.usage.completion_tokens || 'n/a'}`;
    }
    return responseData;
  }

  async function sendLLMPrompt() {
    const prompt = document.getElementById('llm-prompt');
    if (!prompt) return;
    await callLLM(prompt.value.trim());
  }

  async function summarizeAndRecord() {
    const respBox = document.getElementById('llm-response');
    const status = document.getElementById('llm-status');
    const selector = document.getElementById('finding-selector');
    const targetFinding = selector ? selector.value : '';
    const responseText = respBox ? respBox.textContent.trim() : '';
    if (!responseText) {
      if (status) status.textContent = 'No LLM response to summarize yet.';
      return;
    }
    const summaryPrompt = `Summarize the following LLM answer so it can be stored alongside a log finding. Keep it concise.\n\n${responseText}`;
    const data = await callLLM(summaryPrompt);
    if (!data) return;
    if (!targetFinding) {
      if (status) status.textContent = 'Summary created. Select a finding to record it.';
      return;
    }
    recordedSummaries[targetFinding] = data.content || '';
    const summaryEl = document.querySelector(`[data-summary-for="${targetFinding}"]`);
    if (summaryEl) {
      summaryEl.textContent = `Recorded summary: ${recordedSummaries[targetFinding]}`;
      summaryEl.style.display = 'block';
    }
    if (status) status.textContent = 'Summary recorded for finding #' + targetFinding;
  }

  updateProviderHints();
  const providerSelect = document.getElementById('llm-provider');
  if (providerSelect) {
    providerSelect.addEventListener('change', updateProviderHints);
  }
</script>
{% endblock %}
