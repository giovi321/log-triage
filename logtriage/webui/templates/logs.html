{% extends "base.html" %}
{% block content %}
<style>
  .log-line { display:flex; align-items:flex-start; gap:0.55rem; padding:0.1rem 0; }
  .log-line input[type="checkbox"] { margin-top:0.15rem; }
</style>
<div class="card">
  <h2>Logs explorer</h2>
  <p class="helper-text">Pick a module to browse its log tail and recent chunk summaries. Use the copy helpers to share errors or snippets quickly.</p>
  <form method="get" action="{{ url_for('module_logs') }}" style="margin-bottom:0.75rem;">
    <label>Module:
      <select name="module" onchange="this.form.submit()">
        {% for m in modules %}
        <option value="{{ m.name }}" {% if current_module and m.name == current_module.name %}selected{% endif %}>{{ m.name }}</option>
        {% endfor %}
      </select>
    </label>
    <span class="muted" style="margin-left:0.5rem;">Path: {{ current_module.path if current_module else '-' }}</span>
  </form>

  {% if not modules %}
    <p class="muted">No modules configured yet.</p>
  {% elif not current_module %}
    <p class="muted">Select a module to view its logs.</p>
  {% else %}
    <div class="grid wide-two-col" style="gap:1.5rem;">
      <div>
        <h3>Log tail</h3>
        {% if sample_lines %}
          <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:0.35rem;">
            <button type="button" class="secondary" onclick="copyAllLines()">Copy all lines</button>
            <button type="button" class="secondary" onclick="copySelectedLines()">Copy selected lines</button>
          </div>
          <div id="log-lines" style="max-height:520px; overflow:auto; border:1px solid #222a38; border-radius:0.65rem; padding:0.5rem; background:#0f131b;">
            {% for line in sample_lines %}
              <div class="log-line" style="font-family:monospace; font-size:0.92rem;">
                <input type="checkbox" name="selected_line" value="{{ loop.index0 }}" data-line="{{ line|replace('\n','')|e }}">
                <span style="min-width:3.25rem; color:#9fb1d3;">{{ "%4d" % loop.index0 }}:</span>
                <span style="flex:1; white-space:pre-wrap; word-break:break-word;">{{ line }}</span>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="muted">No lines read from this log path.</p>
        {% endif %}
      </div>

      <div>
        <h3>Recent chunk summaries</h3>
        {% if not db_status.connected %}
          <p class="muted">Database not connected; start the log-triage process with database.url configured to see chunk history.</p>
        {% elif not recent_chunks %}
          <p class="muted">No chunks recorded yet for this module.</p>
        {% else %}
          <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:0.35rem;">
            <button type="button" class="secondary" onclick="copyAllChunks()">Copy all summaries</button>
          </div>
          <div style="max-height:520px; overflow:auto; border:1px solid #222a38; border-radius:0.65rem; padding:0.5rem; background:#0f131b;">
            {% for c in recent_chunks %}
              <div style="padding:0.5rem 0.25rem; border-bottom:1px solid #1f2530;">
                <div style="display:flex; justify-content:space-between; gap:0.5rem; align-items:center;">
                  <div style="display:flex; gap:0.4rem; align-items:center; flex-wrap:wrap;">
                    <span class="status-badge sev-{{ c.severity }}">{{ c.severity }}</span>
                    <span style="font-size:0.85rem; color:#9fb1d3;">{{ c.created_at }}</span>
                  </div>
                  <button type="button" class="secondary" data-summary="[{{ c.severity }}] {{ c.created_at }} â€” {{ c.reason }} (errors: {{ c.error_count }}, warnings: {{ c.warning_count }}, lines: {{ c.line_count }})" onclick="copyChunk(this)">Copy</button>
                </div>
                <div class="helper-text" style="margin:0.25rem 0;">errors: {{ c.error_count }}, warnings: {{ c.warning_count }}, lines: {{ c.line_count }}{% if c.anomaly_flag %}, anomaly{% endif %}</div>
                <div style="font-family:monospace; font-size:0.95rem; white-space:pre-wrap;">{{ c.reason }}</div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>

<script>
  const sampleLines = {{ sample_lines|tojson }};

  function copyText(text) {
    if (!navigator.clipboard) {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    } else {
      navigator.clipboard.writeText(text);
    }
  }

  function copyAllLines() {
    copyText(sampleLines.join('\n'));
  }

  function copySelectedLines() {
    const selected = Array.from(document.querySelectorAll('input[name="selected_line"]:checked'))
      .map(cb => cb.dataset.line)
      .filter(Boolean);
    copyText(selected.join('\n'));
  }

  function copyChunk(btn) {
    const text = btn.dataset.summary || '';
    copyText(text);
  }

  function copyAllChunks() {
    const summaries = Array.from(document.querySelectorAll('button[data-summary]')).map(btn => btn.dataset.summary);
    copyText(summaries.join('\n'));
  }
</script>
{% endblock %}
