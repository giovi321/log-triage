{% extends "base.html" %}
{% block content %}
<style>
  .log-line { display:flex; align-items:flex-start; gap:0.55rem; padding:0.1rem 0; }
  .log-line input[type="checkbox"] { margin-top:0.15rem; }
  .log-line.selected { background:#182233; border-radius:0.4rem; padding:0.25rem 0.2rem; }
  .log-section { border:1px solid #222a38; border-radius:0.65rem; margin-bottom:0.75rem; overflow:hidden; }
  .log-section-header { display:flex; gap:0.5rem; align-items:center; justify-content:space-between; padding:0.45rem 0.5rem; background:#111520; border-bottom:1px solid #1f2530; }
  .log-section-body { padding:0.35rem 0.45rem; display:flex; flex-direction:column; gap:0.1rem; }
  .log-section.collapsed .log-section-body { display:none; }
  .log-section .section-actions { display:flex; gap:0.35rem; align-items:center; flex-wrap:wrap; }
  .log-section.highlighted-chunk { border-color:#4f6fa9; box-shadow:0 0 0 1px #4f6fa9; }
  .chunk-summary { padding:0.5rem 0.25rem; border-bottom:1px solid #1f2530; cursor:pointer; border-radius:0.45rem; transition:background 0.15s ease, box-shadow 0.15s ease; }
  .chunk-summary:hover { background:#121a27; }
  .chunk-summary.active { box-shadow:0 0 0 1px #3f5d95; background:#111827; }
</style>
<div class="card">
  <h2>Logs explorer</h2>
  <p class="helper-text">Pick a module to browse its log tail and recent chunk summaries. Use the copy helpers to share errors or snippets quickly.</p>
  {% if message %}
    <div class="helper-text" style="margin:0.35rem 0; padding:0.4rem 0.6rem; border:1px solid #2e4735; background:#142018; color:#b7e6c5; border-radius:0.5rem;">{{ message }}</div>
  {% endif %}
  {% if error %}
    <div class="helper-text" style="margin:0.35rem 0; padding:0.4rem 0.6rem; border:1px solid #5c2f2f; background:#1c1114; color:#ffcdd2; border-radius:0.5rem;">{{ error }}</div>
  {% endif %}
  <form method="get" action="{{ url_for('module_logs') }}" style="margin-bottom:0.75rem;">
    <label>Module:
      <select name="module" onchange="this.form.submit()">
        {% for m in modules %}
        <option value="{{ m.name }}" {% if current_module and m.name == current_module.name %}selected{% endif %}>{{ m.name }}</option>
        {% endfor %}
      </select>
    </label>
    <label style="margin-left:0.75rem;">Tail view:
      <select name="tail_filter" onchange="this.form.submit()">
        <option value="all" {% if tail_filter == 'ALL' %}selected{% endif %}>All lines</option>
        {% for sev in tail_severities %}
          <option value="{{ sev }}" {% if tail_filter == sev %}selected{% endif %}>{{ sev }} only</option>
        {% endfor %}
      </select>
    </label>
    <span class="muted" style="margin-left:0.5rem;">Path: {{ current_module.path if current_module else '-' }}</span>
  </form>

  {% if not modules %}
    <p class="muted">No modules configured yet.</p>
  {% elif not current_module %}
    <p class="muted">Select a module to view its logs.</p>
  {% else %}
    <div class="grid wide-two-col" style="gap:1.5rem;">
      <div>
        <h3>Log tail</h3>
        {% if sample_lines %}
          <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:0.35rem;">
            <button type="button" class="secondary" onclick="copyAllLines()">Copy all lines</button>
            <button type="button" class="secondary" onclick="copySelectedLines()">Copy selected lines</button>
            <button type="button" class="secondary" onclick="toggleAllChunks()" id="toggle-all-chunks">Collapse chunks</button>
            {% if tail_filter != 'ALL' %}
              <a href="{{ url_for('module_logs') }}?module={{ current_module.name }}" style="display:inline-flex; align-items:center; padding:0.45rem 0.65rem; border:1px solid #2b3242; border-radius:0.35rem; text-decoration:none; color:#e8ecf2;">Reset tail filter</a>
            {% endif %}
          </div>
          <div id="log-lines" style="max-height:520px; overflow:auto; border:1px solid #222a38; border-radius:0.65rem; padding:0.5rem; background:#0f131b;">
            {% if chunked_tail %}
              {% for section in chunked_tail %}
                <div class="log-section" {% if section.chunk %}data-chunk-section="true"{% endif %}>
                      <div class="log-section-header">
                        {% if section.chunk %}
                          <div style="display:flex; gap:0.4rem; align-items:center; flex-wrap:wrap;">
                            <span class="status-badge sev-{{ section.chunk.severity }}">{{ section.chunk.severity }}</span>
                            <span class="muted" style="font-size:0.85rem;">Chunk #{{ section.chunk.chunk_index }} · {{ section.chunk.created_at|localtime }}</span>
                          </div>
                          <div class="section-actions" style="flex:1; justify-content:flex-end;">
                            <div class="helper-text" style="text-align:right;">{{ section.chunk.reason }}</div>
                            <form method="post" action="{{ url_for('mark_chunk_false_positive') }}" style="margin:0; display:inline-flex; align-items:center; gap:0.25rem;">
                              <input type="hidden" name="chunk_id" value="{{ section.chunk.id }}">
                              <input type="hidden" name="module" value="{{ current_module.name }}">
                              <input type="hidden" name="tail_filter" value="{{ tail_filter }}">
                              <input type="hidden" name="sample_line" value="{{ section.lines[0].text|e if section.lines else section.chunk.reason|e }}">
                              <button type="submit" class="secondary">False positive</button>
                            </form>
                            <form method="post" action="{{ url_for('mark_chunk_addressed') }}" style="margin:0; display:inline-flex; align-items:center; gap:0.25rem;">
                              <input type="hidden" name="chunk_id" value="{{ section.chunk.id }}">
                              <input type="hidden" name="module" value="{{ current_module.name }}">
                              <input type="hidden" name="tail_filter" value="{{ tail_filter }}">
                              <button type="submit" class="secondary">Addressed</button>
                            </form>
                            <button type="button" class="secondary" data-section-index="{{ loop.index0 }}" onclick="toggleSection(this)">Collapse</button>
                          </div>
                        {% else %}
                          <div class="muted">Tail lines</div>
                        {% endif %}
                      </div>
                  <div class="log-section-body">
                    {% for line in section.lines %}
                      <div class="log-line" style="font-family:monospace; font-size:0.92rem;" data-line-index="{{ line.index }}">
                        <input type="checkbox" name="selected_line" value="{{ line.index }}" data-line="{{ line.text|replace('\n','')|e }}">
                        <span style="min-width:3.25rem; color:#9fb1d3;">{{ "%4d" % line.index }}:</span>
                        <span style="flex:1; white-space:pre-wrap; word-break:break-word;">{{ line.text }}</span>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            {% elif had_chunked_tail and tail_filter != 'ALL' %}
              <p class="muted" style="margin:0.5rem 0;">No log sections matched the {{ tail_filter }} filter.</p>
            {% else %}
              {% for line in sample_lines %}
                <div class="log-line" style="font-family:monospace; font-size:0.92rem;">
                  <input type="checkbox" name="selected_line" value="{{ loop.index0 }}" data-line="{{ line|replace('\n','')|e }}">
                  <span style="min-width:3.25rem; color:#9fb1d3;">{{ "%4d" % loop.index0 }}:</span>
                  <span style="flex:1; white-space:pre-wrap; word-break:break-word;">{{ line }}</span>
                </div>
              {% endfor %}
            {% endif %}
          </div>
        {% else %}
          <p class="muted">No lines read from this log path.</p>
        {% endif %}
      </div>

      <div>
        <h3>Recent chunk summaries</h3>
        {% if not db_status.connected %}
          <p class="muted">Database not connected; start the log-triage process with database.url configured to see chunk history.</p>
        {% elif not recent_chunks %}
          <p class="muted">No chunks recorded yet for this module.</p>
        {% else %}
          <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:0.35rem;">
            <button type="button" class="secondary" onclick="copyAllChunks()">Copy all summaries</button>
            <form method="post" action="{{ url_for('flush_logs_db') }}" style="margin:0;">
              <input type="hidden" name="module" value="{{ current_module.name }}">
              <input type="hidden" name="tail_filter" value="{{ tail_filter }}">
              <button type="submit" class="secondary" style="border-color:#5c2f2f; color:#ffcdd2;">Flush database</button>
            </form>
          </div>
          <div style="max-height:520px; overflow:auto; border:1px solid #222a38; border-radius:0.65rem; padding:0.5rem; background:#0f131b;">
            {% for c in recent_chunks %}
              <div style="padding:0.5rem 0.25rem; border-bottom:1px solid #1f2530;">
                  <div style="display:flex; justify-content:space-between; gap:0.5rem; align-items:center;">
                    <div style="display:flex; gap:0.4rem; align-items:center; flex-wrap:wrap;">
                      <span class="status-badge sev-{{ c.severity }}">{{ c.severity }}</span>
                      <span style="font-size:0.85rem; color:#9fb1d3;">{{ c.created_at|localtime }}</span>
                    </div>
                    <div style="display:flex; gap:0.4rem; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
                      <button type="button" class="secondary" data-summary="[{{ c.severity }}] {{ c.created_at|localtime }} — {{ c.reason }} (errors: {{ c.error_count }}, warnings: {{ c.warning_count }}, lines: {{ c.line_count }})" onclick="copyChunk(this)">Copy</button>
                      <form method="post" action="{{ url_for('delete_chunk') }}" style="margin:0; display:inline-flex; gap:0.25rem; align-items:center;">
                        <input type="hidden" name="chunk_id" value="{{ c.id }}">
                        <input type="hidden" name="module" value="{{ current_module.name }}">
                        <input type="hidden" name="tail_filter" value="{{ tail_filter }}">
                        <button type="submit" class="secondary" style="border-color:#5c2f2f; color:#ffcdd2;">Delete</button>
                      </form>
                      <form method="post" action="{{ url_for('mark_chunk_false_positive') }}" style="margin:0; display:inline-flex; gap:0.25rem; align-items:center;">
                        <input type="hidden" name="chunk_id" value="{{ c.id }}">
                        <input type="hidden" name="module" value="{{ current_module.name }}">
                        <input type="hidden" name="tail_filter" value="{{ tail_filter }}">
                        <input type="hidden" name="sample_line" value="{{ c.reason|e }}">
                        <button type="submit" class="secondary">False positive</button>
                      </form>
                      <form method="post" action="{{ url_for('mark_chunk_addressed') }}" style="margin:0; display:inline-flex; gap:0.25rem; align-items:center;">
                        <input type="hidden" name="chunk_id" value="{{ c.id }}">
                        <input type="hidden" name="module" value="{{ current_module.name }}">
                        <input type="hidden" name="tail_filter" value="{{ tail_filter }}">
                        <button type="submit" class="secondary">Addressed</button>
                      </form>
                    </div>
                  </div>
                <div class="helper-text" style="margin:0.25rem 0; display:flex; justify-content:space-between; gap:0.5rem; align-items:center; flex-wrap:wrap;">
                  <span>errors: {{ c.error_count }}, warnings: {{ c.warning_count }}, lines: {{ c.line_count }}{% if c.anomaly_flag %}, anomaly{% endif %}</span>
                  <form method="post" action="{{ url_for('change_chunk_severity') }}" style="margin:0; display:inline-flex; gap:0.25rem; align-items:center;">
                    <input type="hidden" name="chunk_id" value="{{ c.id }}">
                    <input type="hidden" name="module" value="{{ current_module.name }}">
                    <input type="hidden" name="tail_filter" value="{{ tail_filter }}">
                    <label class="muted" style="font-size:0.9rem;">Severity
                      <select name="severity">
                        {% for sev in severity_choices %}
                          <option value="{{ sev }}" {% if sev == c.severity %}selected{% endif %}>{{ sev }}</option>
                        {% endfor %}
                      </select>
                    </label>
                    <button type="submit" class="secondary">Update</button>
                  </form>
                </div>
                <div style="font-family:monospace; font-size:0.95rem; white-space:pre-wrap;">{{ c.reason }}</div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>

<script>
  const sampleLines = {{ sample_lines|tojson }};

  function copyText(text) {
    if (!navigator.clipboard) {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    } else {
      navigator.clipboard.writeText(text);
    }
  }

  function copyAllLines() {
    copyText(sampleLines.join('\n'));
  }

  function copySelectedLines() {
    const selected = Array.from(document.querySelectorAll('input[name="selected_line"]:checked'))
      .map(cb => cb.dataset.line)
      .filter(Boolean);
    copyText(selected.join('\n'));
  }

  function refreshSelectedHighlights() {
    document.querySelectorAll('.log-line').forEach(row => {
      const cb = row.querySelector('input[name="selected_line"]');
      row.classList.toggle('selected', cb && cb.checked);
    });
  }

  document.querySelectorAll('input[name="selected_line"]').forEach(cb => {
    cb.addEventListener('change', refreshSelectedHighlights);
  });

  refreshSelectedHighlights();

  function focusChunkSection(chunkId) {
    if (!chunkId) return;

    const section = document.querySelector(`.log-section[data-chunk-id="${chunkId}"]`);
    if (!section) return;

    document.querySelectorAll('.log-section.highlighted-chunk').forEach(sec => sec.classList.remove('highlighted-chunk'));
    document.querySelectorAll('.chunk-summary.active').forEach(el => el.classList.remove('active'));

    document.querySelectorAll('#log-lines input[name="selected_line"]').forEach(cb => {
      cb.checked = false;
    });

    section.querySelectorAll('input[name="selected_line"]').forEach(cb => {
      cb.checked = true;
    });

    if (section.classList.contains('collapsed')) {
      section.classList.remove('collapsed');
      const toggleBtn = section.querySelector('button[data-section-index]');
      if (toggleBtn) toggleBtn.textContent = 'Collapse';
    }

    refreshSelectedHighlights();

    section.classList.add('highlighted-chunk');
    const relatedSummary = document.querySelector(`.chunk-summary[data-chunk-id="${chunkId}"]`);
    if (relatedSummary) {
      relatedSummary.classList.add('active');
    }

    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  document.querySelectorAll('[data-chunk-summary]').forEach(summary => {
    summary.addEventListener('click', (event) => {
      const chunkId = summary.dataset.chunkId;
      if (!chunkId) return;

      const tag = event.target.tagName;
      const interactiveTags = new Set(['BUTTON', 'SELECT', 'OPTION']);
      if (interactiveTags.has(tag)) return;

      focusChunkSection(chunkId);
    });
  });

  function copyChunk(btn) {
    const text = btn.dataset.summary || '';
    copyText(text);
  }

  function copyAllChunks() {
    const summaries = Array.from(document.querySelectorAll('button[data-summary]')).map(btn => btn.dataset.summary);
    copyText(summaries.join('\n'));
  }

  function toggleSection(btn) {
    const section = btn.closest('.log-section');
    if (!section) return;
    const collapsed = section.classList.toggle('collapsed');
    btn.textContent = collapsed ? 'Expand' : 'Collapse';
  }

  function toggleAllChunks() {
    const sections = Array.from(document.querySelectorAll('#log-lines .log-section[data-chunk-section="true"]'));
    const allCollapsed = sections.every(sec => sec.classList.contains('collapsed'));
    sections.forEach(sec => {
      const shouldCollapse = !allCollapsed;
      sec.classList.toggle('collapsed', shouldCollapse);
      const btn = sec.querySelector('button[data-section-index]');
      if (btn) btn.textContent = shouldCollapse ? 'Expand' : 'Collapse';
    });
    const masterBtn = document.getElementById('toggle-all-chunks');
    if (masterBtn) {
      masterBtn.textContent = allCollapsed ? 'Collapse chunks' : 'Expand chunks';
    }
  }
</script>
{% endblock %}
