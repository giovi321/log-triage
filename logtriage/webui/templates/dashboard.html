{% extends "base.html" %}
{% block content %}
<div class="card">
  <h2>Data plane status</h2>
  <div class="status-strip">
    {% if db_status.configured %}
      {% if db_status.connected %}
        <span class="status-chip ok">Database connected</span>
      {% elif db_status.error %}
        <span class="status-chip error">DB error: {{ db_status.error }}</span>
      {% else %}
        <span class="status-chip warn">Database unreachable</span>
      {% endif %}
      <span class="status-chip">URL: {{ db_status.url }}</span>
    {% else %}
      <span class="status-chip warn">Database URL not set</span>
    {% endif %}
    {% if ingestion_status and ingestion_status.stale_modules %}
      <span class="status-chip traffic {{ ingestion_status.state_class }}">
        <span class="traffic-dot"></span>
        <span class="muted">Stale: {{ ingestion_status.stale_modules|join(', ') }}</span>
      </span>
    {% endif %}
    {% if page_rendered_at %}
      <span class="status-chip">Page last updated: {{ page_rendered_at|localtime }}</span>
    {% endif %}
    {% if ingestion_status and ingestion_status.latest_log_update %}
      <span class="status-chip">Latest log activity: {{ ingestion_status.latest_log_update|localtime }}</span>
    {% endif %}
  </div>
</div>

{% if rag_status %}
<div class="card">
  <h2>Knowledge Base (RAG) Status</h2>
  <div class="status-strip">
    {% if rag_service_available and rag_service_ready %}
      <span class="status-chip ok">RAG Enabled</span>
      <span class="status-chip">Repositories: {{ rag_status.total_repositories }}</span>
      <span class="status-chip">Total chunks: {{ rag_status.vector_store_stats.total_chunks }}</span>
      <span class="status-chip" id="rag-live-updating">Live indexing: n/a</span>
      <span class="status-chip" id="rag-live-rss">RAG memory: n/a</span>
      <span class="status-chip" id="rag-live-init">Init: n/a</span>
    {% elif rag_service_available and not rag_service_ready %}
      <span class="status-chip warn">RAG Initializing</span>
      <span class="status-chip" id="rag-live-updating">Live indexing: n/a</span>
      <span class="status-chip" id="rag-live-rss">RAG memory: n/a</span>
      <span class="status-chip" id="rag-live-init">Init: n/a</span>
    {% else %}
      <span class="status-chip warn">RAG Disabled</span>
      <span class="status-chip">Service unavailable</span>
    {% endif %}
  </div>
  
  {% if rag_service_available %}
  <div style="margin-top: 1rem;">
    <table style="font-size:0.85rem;" id="rag-repos-table">
      <thead>
        <tr>
          <th>Repository</th>
          <th>Branch</th>
          <th>Last Commit</th>
          <th>Indexed</th>
          <th style="text-align:right;">Chunks</th>
          <th style="text-align:right;">Progress</th>
          <th>Status</th>
          <th>Local Path</th>
        </tr>
      </thead>
      <tbody id="rag-repos-body">
        {% if rag_service_ready and rag_status.enabled and rag_status.repositories %}
        {% for repo in rag_status.repositories %}
        <tr data-repo-id="{{ repo.repo_id }}">
          <td style="font-family:monospace; font-size:0.8rem;">
            <a href="{{ repo.url }}" target="_blank" style="color: inherit; text-decoration: none;" title="{{ repo.url }}">{{ repo.url.split('/')[-1] }}</a>
          </td>
          <td><span class="tag">{{ repo.branch }}</span></td>
          <td style="font-family:monospace; font-size:0.8rem;">{{ repo.last_commit_hash[:8] }}</td>
          <td style="font-family:monospace; font-size:0.8rem;">
            {% if repo.last_indexed_hash %}{{ repo.last_indexed_hash[:8] }}{% else %}<span class="muted">never</span>{% endif %}
          </td>
          <td style="text-align:right; font-family:monospace; padding-right: 0.75rem;">{{ repo.chunk_count }}</td>
          <td class="rag-progress" data-repo-id="{{ repo.repo_id }}" style="text-align:right; font-family:monospace; font-size:0.75rem; padding-right: 0.75rem;">-</td>
          <td>
            {% if repo.needs_reindexing %}
              <span class="status-badge sev-WARNING" title="New commits available, needs reindexing">⚠️</span>
            {% elif repo.chunk_count == 0 %}
              <span class="status-badge sev-ERROR" title="Repository cloned but no indexed content">❌</span>
            {% else %}
              <span class="status-badge sev-OK" title="Repository indexed and current">✅</span>
            {% endif %}
          </td>
          <td style="font-family:monospace; font-size:0.7rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="{{ repo.local_path }}">
            {{ repo.local_path }}
          </td>
        </tr>
        {% endfor %}
        {% endif %}
      </tbody>
    </table>
  </div>
  {% endif %}
</div>
{% endif %}

<script>
  (function() {
    async function refreshRagProgress() {
      try {
        const response = await fetch('/api/rag/progress');
        if (!response.ok) {
          return;
        }
        const payload = await response.json();
        const progress = payload && payload.progress ? payload.progress : null;

        const initEl = document.getElementById('rag-live-init');
        const rssEl = document.getElementById('rag-live-rss');
        const updatingEl = document.getElementById('rag-live-updating');

        if (!progress) {
          if (updatingEl) {
            updatingEl.textContent = 'Live indexing: unavailable';
            updatingEl.className = 'status-chip warn';
          }
          if (rssEl) {
            rssEl.textContent = 'RAG RSS: n/a';
          }
          if (initEl) {
            initEl.textContent = 'Init: n/a';
          }
          return;
        }

        const init = progress.initialization || {};
        const initProgress = (init.progress || {});
        const initText = initProgress.step_description || init.current_phase || 'n/a';
        const idx = progress.indexing_progress || {};
        const idxMeta = idx.indexing || {};
        const idxRepos = idx.repositories || {};
        const updating = !!idxMeta.updating;
        const done = (typeof idxMeta.repos_done === 'number') ? idxMeta.repos_done : 0;
        const total = (typeof idxMeta.repos_total === 'number') ? idxMeta.repos_total : 0;
        const filesOverallPct = (typeof idxMeta.overall_pct === 'number') ? idxMeta.overall_pct : null;

        let initPct = (typeof initProgress.percentage === 'number') ? initProgress.percentage : null;
        if (init && init.updating && updating) {
          if (filesOverallPct !== null) {
            initPct = filesOverallPct;
          } else if (idxRepos && typeof idxRepos === 'object') {
            let filesDone = 0;
            let filesTotal = 0;
            Object.values(idxRepos).forEach((repo) => {
              if (!repo || typeof repo !== 'object') {
                return;
              }
              const tot = (typeof repo.file_total === 'number') ? repo.file_total : 0;
              const cur = (typeof repo.file_current === 'number') ? repo.file_current : 0;
              if (tot <= 0) {
                return;
              }
              filesTotal += tot;
              if (repo.state === 'done') {
                filesDone += tot;
              } else {
                filesDone += Math.max(0, Math.min(tot, cur));
              }
            });
            if (filesTotal > 0) {
              initPct = (filesDone / filesTotal) * 100;
            }
          } else if (total > 0) {
            initPct = (done / total) * 100;
          }
        }
        const initPctText = (typeof initPct === 'number') ? initPct.toFixed(0) : null;
        if (initEl) {
          initEl.textContent = initPctText !== null ? `Init: ${initText} (${initPctText}%)` : `Init: ${initText}`;
          initEl.className = 'status-chip' + (init.updating ? ' warn' : '');
        }

        const proc = progress.process || {};
        if (rssEl) {
          if (typeof proc.rss_gb === 'number') {
            rssEl.textContent = `RAG memory: ${proc.rss_gb.toFixed(2)}GB`;
          } else {
            rssEl.textContent = 'RAG memory: n/a';
          }
        }

        if (updatingEl) {
          updatingEl.textContent = updating ? `Live indexing: running (${done}/${total})` : 'Live indexing: idle';
          updatingEl.className = updating ? 'status-chip warn' : 'status-chip';
        }

        const tbody = document.getElementById('rag-repos-body');
        if (tbody && idxRepos && typeof idxRepos === 'object') {
          const existing = {};
          tbody.querySelectorAll('tr[data-repo-id]').forEach((row) => {
            const repoId = row.getAttribute('data-repo-id');
            if (repoId) {
              existing[repoId] = row;
            }
          });

          Object.entries(idxRepos).forEach(([repoId, repo]) => {
            if (!repo || typeof repo !== 'object') {
              return;
            }
            if (!existing[repoId]) {
              const url = repo.url || null;
              const name = url ? url.split('/').slice(-1)[0] : repoId;
              const branch = repo.branch || '-';
              const localPath = repo.local_path || '-';

              const row = document.createElement('tr');
              row.setAttribute('data-repo-id', repoId);
              row.innerHTML = `
                <td style="font-family:monospace; font-size:0.8rem;">${url ? `<a href="${url}" target="_blank" style="color: inherit; text-decoration: none;" title="${url}">${name}</a>` : name}</td>
                <td><span class="tag">${branch}</span></td>
                <td style="font-family:monospace; font-size:0.8rem;">-</td>
                <td style="font-family:monospace; font-size:0.8rem;"><span class="muted">-</span></td>
                <td style="text-align:right; font-family:monospace; padding-right: 0.75rem;">-</td>
                <td class="rag-progress" data-repo-id="${repoId}" style="text-align:right; font-family:monospace; font-size:0.75rem; padding-right: 0.75rem;">-</td>
                <td style="font-family:monospace; font-size:0.75rem;">-</td>
                <td style="font-family:monospace; font-size:0.7rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${localPath}">${localPath}</td>
              `;
              tbody.appendChild(row);
              existing[repoId] = row;
            }
          });

          const cells = document.querySelectorAll('td.rag-progress');
          cells.forEach((cell) => {
            const repoId = cell.getAttribute('data-repo-id');
            const repo = repoId ? idxRepos[repoId] : null;
            if (!repo || typeof repo !== 'object') {
              cell.textContent = '-';
              return;
            }
            const state = repo.state || 'n/a';
            const cur = (typeof repo.file_current === 'number') ? repo.file_current : 0;
            const tot = (typeof repo.file_total === 'number') ? repo.file_total : 0;
            const pct = (tot > 0) ? Math.round((cur / tot) * 100) : null;

            const parts = [];
            parts.push(state);
            if (tot > 0) {
              parts.push(`${cur}/${tot}`);
              if (pct !== null) {
                parts.push(`(${pct}%)`);
              }
            }
            cell.textContent = parts.join(' ');
          });
        }
      } catch (e) {
        return;
      }
    }

    refreshRagProgress();
    setInterval(refreshRagProgress, 2000);
  })();
</script>

<br>

<div class="card">
  <h2>Modules</h2>
  <p class="helper-text">Live view of configured modules with last log updates and their severities.</p>
  {% if modules %}
    <table style="font-size:0.9rem;">
      <thead>
        <tr>
          <th>Name</th>
          <th>Mode</th>
          <th>Path</th>
          <th>Pipeline</th>
          <th>Enabled</th>
          <th>Status</th>
          <th>Last log update</th>
          <th style="text-align:right;">24h errors</th>
          <th style="text-align:right;">24h warnings</th>
        </tr>
      </thead>
      <tbody>
        {% for m in modules %}
        {% set st = stats.get(m.name) if stats else None %}
        <tr class="{% if not m.enabled %}module-disabled{% endif %}">
          <td>{{ m.name }}</td>
          <td><span class="tag">{{ m.mode }}</span></td>
          <td style="font-family:monospace; font-size:0.85rem;">{{ m.path }}</td>
          <td>{{ m.pipeline_name or "-" }}</td>
          <td>{{ "yes" if m.enabled else "no" }}</td>
          <td>
            {% set status = "OK" %}
            {% if ingestion_status and m.name in ingestion_status.stale_modules %}
              {% set status = "STALE" %}
            {% elif st %}
              {% set sev_upper = (st.last_severity or "")|upper %}
              {% if st.errors_24h > 0 or sev_upper in ("ERROR", "CRITICAL") %}
                {% set status = "ERROR" if sev_upper != "CRITICAL" else "CRITICAL" %}
              {% elif st.warnings_24h > 0 or sev_upper == "WARNING" %}
                {% set status = "WARNING" %}
              {% endif %}
            {% endif %}
            <span class="status-badge sev-{{ status }}">{{ status }}</span>
          </td>
          <td style="font-size:0.85rem;">
            {% if st and st.last_log_update %}{{ st.last_log_update|localtime }}{% else %}<span class="muted">n/a</span>{% endif %}
          </td>
          <td style="text-align:right;">{{ st.errors_24h if st else 0 }}</td>
          <td style="text-align:right;">{{ st.warnings_24h if st else 0 }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted">No modules configured.</p>
  {% endif %}
</div>
{% endblock %}
