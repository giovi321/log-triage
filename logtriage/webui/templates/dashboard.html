{% extends "base.html" %}
{% block content %}
<div class="card">
  <h2>Data plane status</h2>
  <div class="status-strip">
    {% if db_status.configured %}
      {% if db_status.connected %}
        <span class="status-chip ok">Database connected</span>
      {% elif db_status.error %}
        <span class="status-chip error">DB error: {{ db_status.error }}</span>
      {% else %}
        <span class="status-chip warn">Database unreachable</span>
      {% endif %}
      <span class="status-chip">URL: {{ db_status.url }}</span>
    {% else %}
      <span class="status-chip warn">Database URL not set</span>
    {% endif %}
    {% if ingestion_status and ingestion_status.stale_modules %}
      <span class="status-chip traffic {{ ingestion_status.state_class }}">
        <span class="traffic-dot"></span>
        <span class="muted">Stale: {{ ingestion_status.stale_modules|join(', ') }}</span>
      </span>
    {% endif %}
    {% if page_rendered_at %}
      <span class="status-chip">Page last updated: {{ page_rendered_at|localtime }}</span>
    {% endif %}
    {% if ingestion_status and ingestion_status.latest_log_update %}
      <span class="status-chip">Latest log activity: {{ ingestion_status.latest_log_update|localtime }}</span>
    {% endif %}
  </div>

<script type="application/json" id="rag-api-urls-json">{{ {
  'reindexBase': url_for('reindex_rag_repo', repo_id='REPO_ID'),
  'progress': url_for('rag_progress')
}|tojson }}</script>
</div>

{% if rag_status %}
<div class="card">
  <h2>Knowledge Base (RAG) Status</h2>
  <div class="status-strip">
    {% if rag_service_available and rag_service_ready %}
      <span class="status-chip ok">RAG Enabled</span>
      <span class="status-chip">Repositories: {{ rag_status.total_repositories }}</span>
      <span class="status-chip">Total chunks: {{ rag_status.vector_store_stats.total_chunks }}</span>
      <span class="status-chip" id="rag-live-updating">Live indexing: n/a</span>
      <span class="status-chip" id="rag-live-rss">RAG memory: n/a</span>
    {% elif rag_service_available and not rag_service_ready %}
      <span class="status-chip warn">RAG Initializing</span>
      <span class="status-chip" id="rag-live-updating">Live indexing: n/a</span>
      <span class="status-chip" id="rag-live-rss">RAG memory: n/a</span>
    {% else %}
      <span class="status-chip warn">RAG Disabled</span>
      <span class="status-chip">Service unavailable</span>
    {% endif %}
  </div>
  
  {% if rag_service_available %}
  <div style="margin-top: 1rem;">
    <table style="font-size:0.85rem;" id="rag-repos-table">
      <thead>
        <tr>
          <th>Repository</th>
          <th>Branch</th>
          <th>Last Commit</th>
          <th>Indexed</th>
          <th>Actions</th>
          <th style="text-align:right;">Chunks</th>
          <th style="text-align:right;">Progress</th>
          <th>Status</th>
          <th>Local Path</th>
        </tr>
      </thead>
      <tbody id="rag-repos-body">
        {% if rag_service_ready and rag_status.enabled and rag_status.repositories %}
        {% for repo in rag_status.repositories %}
        <tr data-repo-id="{{ repo.repo_id }}">
          <td class="rag-repo-name" style="font-family:monospace; font-size:0.8rem;">
            <a href="{{ repo.url }}" target="_blank" style="color: inherit; text-decoration: none;" title="{{ repo.url }}">{{ repo.url.split('/')[-1] }}</a>
          </td>
          <td class="rag-repo-branch"><span class="tag">{{ repo.branch }}</span></td>
          <td style="font-family:monospace; font-size:0.8rem;">
            <div>{{ repo.last_commit_hash[:8] }}</div>
            <div class="muted" style="font-size:0.75rem;">{% if repo.last_commit_at %}{{ repo.last_commit_at }}{% else %}n/a{% endif %}</div>
          </td>
          <td style="font-family:monospace; font-size:0.8rem;">
            <div>
              {% if repo.last_indexed_hash %}{{ repo.last_indexed_hash[:8] }}{% else %}<span class="muted">never</span>{% endif %}
            </div>
            <div class="muted" style="font-size:0.75rem;">{% if repo.last_indexed_at %}{{ repo.last_indexed_at }}{% else %}n/a{% endif %}</div>
          </td>
          <td style="white-space:nowrap;">
            {% if repo.needs_reindexing %}
              <button type="button" class="secondary rag-reindex-btn" data-repo-id="{{ repo.repo_id }}">Re-index</button>
            {% else %}
              <span class="muted">-</span>
            {% endif %}
          </td>
          <td style="text-align:right; font-family:monospace; padding-right: 0.75rem;">{{ repo.chunk_count }}</td>
          <td class="rag-progress" data-repo-id="{{ repo.repo_id }}" style="text-align:right; font-family:monospace; font-size:0.75rem; padding-right: 0.75rem;">-</td>
          <td>
            {% if repo.needs_reindexing %}
              <span class="status-badge sev-WARNING" title="New commits available, needs reindexing">⚠️</span>
            {% elif repo.chunk_count == 0 %}
              <span class="status-badge sev-ERROR" title="Repository cloned but no indexed content">❌</span>
            {% else %}
              <span class="status-badge sev-OK" title="Repository indexed and current">✅</span>
            {% endif %}
          </td>
          <td class="rag-repo-local-path" style="font-family:monospace; font-size:0.7rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="{{ repo.local_path }}">
            {{ repo.local_path }}
          </td>
        </tr>
        {% endfor %}
        {% endif %}
      </tbody>
    </table>
  </div>
  {% endif %}
</div>
{% endif %}

<script>
  (function() {
    const ragApiUrls = JSON.parse((document.getElementById('rag-api-urls-json') || {}).textContent || '{}');
    const ragReindexBase = (ragApiUrls.reindexBase || '').replace('REPO_ID', '');
    const ragProgressUrl = ragApiUrls.progress || '/api/rag/progress';

    async function triggerReindex(repoId, buttonEl) {
      if (!repoId) {
        return;
      }
      if (buttonEl) {
        buttonEl.disabled = true;
        buttonEl.textContent = 'Queued…';
      }
      try {
        const response = await fetch(`${ragReindexBase}${repoId}`, { method: 'POST' });
        if (!response.ok) {
          const text = await response.text();
          if (buttonEl) {
            buttonEl.disabled = false;
            buttonEl.textContent = 'Re-index';
          }
          alert(text || 'Failed to start reindex');
          return;
        }
        if (buttonEl) {
          buttonEl.textContent = 'Started';
        }
      } catch (e) {
        if (buttonEl) {
          buttonEl.disabled = false;
          buttonEl.textContent = 'Re-index';
        }
        alert('Failed to start reindex');
      }
    }

    document.addEventListener('click', (ev) => {
      const target = ev.target;
      if (!target) {
        return;
      }
      if (target.classList && target.classList.contains('rag-reindex-btn')) {
        const repoId = target.getAttribute('data-repo-id');
        triggerReindex(repoId, target);
      }
    });

    async function refreshRagProgress() {
      try {
        const response = await fetch(ragProgressUrl, { cache: 'no-store' });
        if (!response.ok) {
          return;
        }
        const payload = await response.json();
        const progress = payload && payload.progress ? payload.progress : null;

        const rssEl = document.getElementById('rag-live-rss');
        const updatingEl = document.getElementById('rag-live-updating');

        if (!progress) {
          if (updatingEl) {
            updatingEl.textContent = 'Live indexing: unavailable';
            updatingEl.className = 'status-chip warn';
          }
          if (rssEl) {
            rssEl.textContent = 'RAG RSS: n/a';
          }
          return;
        }

        const init = progress.initialization || {};
        const initProgress = (init.progress || {});
        const idx = progress.indexing_progress || {};
        const idxMeta = idx.indexing || {};
        const idxRepos = idx.repositories || {};
        const updating = !!idxMeta.updating;
        const done = (typeof idxMeta.repos_done === 'number') ? idxMeta.repos_done : 0;
        const total = (typeof idxMeta.repos_total === 'number') ? idxMeta.repos_total : 0;

        const proc = progress.process || {};
        if (rssEl) {
          if (typeof proc.rss_mb === 'number') {
            rssEl.textContent = `RAG memory: ${proc.rss_mb.toFixed(0)}MB`;
          } else if (typeof proc.rss_gb === 'number') {
            rssEl.textContent = `RAG memory: ${proc.rss_gb.toFixed(3)}GB`;
          } else {
            rssEl.textContent = 'RAG memory: n/a';
          }
        }

        if (updatingEl) {
          updatingEl.textContent = updating ? `Live indexing: running (${done}/${total})` : 'Live indexing: idle';
          updatingEl.className = updating ? 'status-chip warn' : 'status-chip';
        }

        const tbody = document.getElementById('rag-repos-body');
        if (tbody && idxRepos && typeof idxRepos === 'object') {
          const existing = {};
          tbody.querySelectorAll('tr[data-repo-id]').forEach((row) => {
            const repoId = row.getAttribute('data-repo-id');
            if (repoId) {
              existing[repoId] = row;
            }
          });

          Object.entries(idxRepos).forEach(([repoId, repo]) => {
            if (!repo || typeof repo !== 'object') {
              return;
            }
            if (!existing[repoId]) {
              const url = repo.url || null;
              const name = url ? url.split('/').slice(-1)[0] : repoId;
              const branch = repo.branch || '-';
              const localPath = repo.local_path || '-';

              const row = document.createElement('tr');
              row.setAttribute('data-repo-id', repoId);
              row.innerHTML = `
                <td class="rag-repo-name" style="font-family:monospace; font-size:0.8rem;">${url ? `<a href="${url}" target="_blank" style="color: inherit; text-decoration: none;" title="${url}">${name}</a>` : '<span class="muted">pending</span>'}</td>
                <td class="rag-repo-branch"><span class="tag">${branch}</span></td>
                <td style="font-family:monospace; font-size:0.8rem;">-</td>
                <td style="font-family:monospace; font-size:0.8rem;"><span class="muted">-</span></td>
                <td style="white-space:nowrap;"><span class="muted">-</span></td>
                <td style="text-align:right; font-family:monospace; padding-right: 0.75rem;">-</td>
                <td class="rag-progress" data-repo-id="${repoId}" style="text-align:right; font-family:monospace; font-size:0.75rem; padding-right: 0.75rem;">-</td>
                <td style="font-family:monospace; font-size:0.75rem;">-</td>
                <td class="rag-repo-local-path" style="font-family:monospace; font-size:0.7rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${localPath}">${localPath}</td>
              `;
              tbody.appendChild(row);
              existing[repoId] = row;
            }

            const row = existing[repoId];
            if (row) {
              const url = repo.url || null;
              const name = url ? url.split('/').slice(-1)[0] : null;
              const branch = repo.branch || null;
              const localPath = repo.local_path || null;

              const nameCell = row.querySelector('td.rag-repo-name');
              if (nameCell && url && name) {
                nameCell.innerHTML = `<a href="${url}" target="_blank" style="color: inherit; text-decoration: none;" title="${url}">${name}</a>`;
              }

              const branchCell = row.querySelector('td.rag-repo-branch');
              if (branchCell && branch) {
                branchCell.innerHTML = `<span class="tag">${branch}</span>`;
              }

              const localCell = row.querySelector('td.rag-repo-local-path');
              if (localCell && localPath) {
                localCell.textContent = localPath;
                localCell.title = localPath;
              }
            }
          });

          const cells = document.querySelectorAll('td.rag-progress');
          cells.forEach((cell) => {
            const repoId = cell.getAttribute('data-repo-id');
            const repo = repoId ? idxRepos[repoId] : null;
            if (!repo || typeof repo !== 'object') {
              cell.textContent = '-';
              return;
            }
            const state = repo.state || 'n/a';
            const cur = (typeof repo.file_current === 'number') ? repo.file_current : 0;
            const tot = (typeof repo.file_total === 'number') ? repo.file_total : 0;
            const pct = (tot > 0) ? Math.round((cur / tot) * 100) : null;

            const parts = [];
            parts.push(state);
            if (tot > 0) {
              parts.push(`${cur}/${tot}`);
              if (pct !== null) {
                parts.push(`(${pct}%)`);
              }
            }
            cell.textContent = parts.join(' ');
          });
        }
      } catch (e) {
        return;
      }
    }

    refreshRagProgress();
    setInterval(refreshRagProgress, 2000);
  })();
</script>

<div class="card">
  <h2>Modules</h2>
  {% if modules %}
    <table style="font-size:0.9rem;">
      <thead>
        <tr>
          <th>Name</th>
          <th>Mode</th>
          <th>Path</th>
          <th>Pipeline</th>
          <th>Enabled</th>
          <th>Status</th>
          <th>Last log update</th>
          <th style="text-align:right;">24h errors</th>
          <th style="text-align:right;">24h warnings</th>
        </tr>
      </thead>
      <tbody>
        {% for m in modules %}
        {% set st = stats.get(m.name) if stats else None %}
        <tr class="{% if not m.enabled %}module-disabled{% endif %}">
          <td>{{ m.name }}</td>
          <td><span class="tag">{{ m.mode }}</span></td>
          <td style="font-family:monospace; font-size:0.85rem;">{{ m.path }}</td>
          <td>{{ m.pipeline_name or "-" }}</td>
          <td>{{ "yes" if m.enabled else "no" }}</td>
          <td>
            {% set status = "OK" %}
            {% if ingestion_status and m.name in ingestion_status.stale_modules %}
              {% set status = "STALE" %}
            {% elif st %}
              {% set sev_upper = (st.last_severity or "")|upper %}
              {% if st.errors_24h > 0 or sev_upper in ("ERROR", "CRITICAL") %}
                {% set status = "ERROR" if sev_upper != "CRITICAL" else "CRITICAL" %}
              {% elif st.warnings_24h > 0 or sev_upper == "WARNING" %}
                {% set status = "WARNING" %}
              {% endif %}
            {% endif %}
            <span class="status-badge sev-{{ status }}">{{ status }}</span>
          </td>
          <td style="font-size:0.85rem;">
            {% if st and st.last_log_update %}{{ st.last_log_update|localtime }}{% else %}<span class="muted">n/a</span>{% endif %}
          </td>
          <td style="text-align:right;">{{ st.errors_24h if st else 0 }}</td>
          <td style="text-align:right;">{{ st.warnings_24h if st else 0 }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted">No modules configured.</p>
  {% endif %}
</div>
{% endblock %}
