{% extends "base.html" %}
{% block content %}
<div class="card">
  <h2>Data plane status</h2>
  <div class="status-strip">
    {% if db_status.configured %}
      {% if db_status.connected %}
        <span class="status-chip ok">Database connected</span>
      {% elif db_status.error %}
        <span class="status-chip error">DB error: {{ db_status.error }}</span>
      {% else %}
        <span class="status-chip warn">Database unreachable</span>
      {% endif %}
      <span class="status-chip">URL: {{ db_status.url }}</span>
    {% else %}
      <span class="status-chip warn">Database URL not set</span>
    {% endif %}
    {% if latest_finding_at %}
      <span class="status-chip">Latest finding: {{ latest_finding_at|localtime }}</span>
    {% else %}
      <span class="status-chip warn">No findings recorded yet</span>
    {% endif %}
    {% if page_rendered_at %}
      <span class="status-chip">Page last updated: {{ page_rendered_at|localtime }}</span>
    {% endif %}
  </div>
  <p class="helper-text" style="margin-top:0.4rem;">If you only see <em>n/a</em> values, make sure the log-triage process (e.g. <code>logtriage run</code>) is running with this same config and writing to the configured database.</p>
</div>

<div class="card">
  <h2>Modules</h2>
  <p class="helper-text">Live view of configured modules with last seen events and their severities.</p>
  {% if modules %}
    <table style="font-size:0.9rem;">
      <thead>
        <tr>
          <th>Name</th>
          <th>Mode</th>
          <th>Path</th>
          <th>Pipeline</th>
          <th>Enabled</th>
          <th>Status</th>
          <th>Last seen</th>
          <th>Last reason</th>
          <th style="text-align:right;">24h errors</th>
          <th style="text-align:right;">24h warnings</th>
          <th style="text-align:right;">24h findings</th>
        </tr>
      </thead>
      <tbody>
        {% for m in modules %}
        {% set st = stats.get(m.name) if stats else None %}
        {% set sev = st.last_severity if st else None %}
        <tr>
          <td>{{ m.name }}</td>
          <td><span class="tag">{{ m.mode }}</span></td>
          <td style="font-family:monospace; font-size:0.85rem;">{{ m.path }}</td>
          <td>{{ m.pipeline_name or "-" }}</td>
          <td>{{ "yes" if m.enabled else "no" }}</td>
          <td>
            {% set status = sev or "OK" %}
            <span class="status-badge sev-{{ status }}">{{ status }}</span>
          </td>
          <td style="font-size:0.85rem;">
            {% if st and st.last_seen %}{{ st.last_seen|localtime }}{% else %}<span class="muted">n/a</span>{% endif %}
          </td>
          <td style="font-size:0.85rem; max-width:240px; overflow:hidden; text-overflow:ellipsis;">
            {% if st and st.last_reason %}{{ st.last_reason }}{% else %}<span class="muted">n/a</span>{% endif %}
          </td>
          <td style="text-align:right;">{{ st.errors_24h if st else 0 }}</td>
          <td style="text-align:right;">{{ st.warnings_24h if st else 0 }}</td>
          <td style="text-align:right;">{{ st.findings_24h if st else 0 }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted">No modules configured.</p>
  {% endif %}
</div>
{% endblock %}
