{% extends "base.html" %}
{% block content %}
<div class="card">
  <h2>Data plane status</h2>
  <div class="status-strip">
    {% if db_status.configured %}
      {% if db_status.connected %}
        <span class="status-chip ok">Database connected</span>
      {% elif db_status.error %}
        <span class="status-chip error">DB error: {{ db_status.error }}</span>
      {% else %}
        <span class="status-chip warn">Database unreachable</span>
      {% endif %}
      <span class="status-chip">URL: {{ db_status.url }}</span>
    {% else %}
      <span class="status-chip warn">Database URL not set</span>
    {% endif %}
    {% if ingestion_status and ingestion_status.stale_modules %}
      <span class="status-chip traffic {{ ingestion_status.state_class }}">
        <span class="traffic-dot"></span>
        <span class="muted">Stale: {{ ingestion_status.stale_modules|join(', ') }}</span>
      </span>
    {% endif %}
    {% if page_rendered_at %}
      <span class="status-chip">Page last updated: {{ page_rendered_at|localtime }}</span>
    {% endif %}
    {% if ingestion_status and ingestion_status.latest_log_update %}
      <span class="status-chip">Latest log activity: {{ ingestion_status.latest_log_update|localtime }}</span>
    {% endif %}
  </div>
</div>

{% if rag_status %}
<div class="card">
  <h2>Knowledge Base (RAG) Status</h2>
  <div class="status-strip">
    {% if rag_service_available and rag_service_ready %}
      <span class="status-chip ok">RAG Enabled</span>
      <span class="status-chip">Repositories: {{ rag_status.total_repositories }}</span>
      <span class="status-chip">Total chunks: {{ rag_status.vector_store_stats.total_chunks }}</span>
      <span class="status-chip">Storage: {{ rag_status.vector_store_stats.persist_directory }}</span>
    {% elif rag_service_available and not rag_service_ready %}
      <span class="status-chip warn">RAG Initializing</span>
      <span class="status-chip">Please wait and refresh the page to see the real status</span>
    {% else %}
      <span class="status-chip warn">RAG Disabled</span>
      <span class="status-chip">Service unavailable</span>
    {% endif %}
  </div>
  
  {% if rag_service_ready and rag_status.enabled and rag_status.repositories %}
  <div style="margin-top: 1rem;">
    <table style="font-size:0.85rem;">
      <thead>
        <tr>
          <th>Repository</th>
          <th>Branch</th>
          <th>Last Commit</th>
          <th>Indexed</th>
          <th style="text-align:right;">Chunks</th>
          <th>Status</th>
          <th>Local Path</th>
        </tr>
      </thead>
      <tbody>
        {% for repo in rag_status.repositories %}
        <tr>
          <td style="font-family:monospace; font-size:0.8rem;">
            <a href="{{ repo.url }}" target="_blank" style="color: inherit; text-decoration: none;" title="{{ repo.url }}">{{ repo.url.split('/')[-1] }}</a>
          </td>
          <td><span class="tag">{{ repo.branch }}</span></td>
          <td style="font-family:monospace; font-size:0.8rem;">{{ repo.last_commit_hash[:8] }}</td>
          <td style="font-family:monospace; font-size:0.8rem;">
            {% if repo.last_indexed_hash %}{{ repo.last_indexed_hash[:8] }}{% else %}<span class="muted">never</span>{% endif %}
          </td>
          <td style="text-align:right; font-family:monospace; padding-right: 0.75rem;">{{ repo.chunk_count }}</td>
          <td>
            {% if repo.needs_reindexing %}
              <span class="status-badge sev-WARNING" title="New commits available, needs reindexing">⚠️</span>
            {% elif repo.chunk_count == 0 %}
              <span class="status-badge sev-ERROR" title="Repository cloned but no indexed content">❌</span>
            {% else %}
              <span class="status-badge sev-OK" title="Repository indexed and current">✅</span>
            {% endif %}
          </td>
          <td style="font-family:monospace; font-size:0.7rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="{{ repo.local_path }}">
            {{ repo.local_path }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
  {% if rag_service_available and rag_service_ready %}
  <div style="margin-top: 1rem; padding: 0.5rem; background: #fff3cd; border-radius: 4px; font-size: 0.8rem;">
    <strong>No repositories configured</strong><br>
    Add RAG knowledge sources to module configurations to enable documentation indexing.
  </div>
  {% endif %}
  {% endif %}
</div>
{% endif %}

<br>

<div class="card">
  <h2>Modules</h2>
  <p class="helper-text">Live view of configured modules with last log updates and their severities.</p>
  {% if modules %}
    <table style="font-size:0.9rem;">
      <thead>
        <tr>
          <th>Name</th>
          <th>Mode</th>
          <th>Path</th>
          <th>Pipeline</th>
          <th>Enabled</th>
          <th>Status</th>
          <th>Last log update</th>
          <th style="text-align:right;">24h errors</th>
          <th style="text-align:right;">24h warnings</th>
        </tr>
      </thead>
      <tbody>
        {% for m in modules %}
        {% set st = stats.get(m.name) if stats else None %}
        <tr class="{% if not m.enabled %}module-disabled{% endif %}">
          <td>{{ m.name }}</td>
          <td><span class="tag">{{ m.mode }}</span></td>
          <td style="font-family:monospace; font-size:0.85rem;">{{ m.path }}</td>
          <td>{{ m.pipeline_name or "-" }}</td>
          <td>{{ "yes" if m.enabled else "no" }}</td>
          <td>
            {% set status = "OK" %}
            {% if ingestion_status and m.name in ingestion_status.stale_modules %}
              {% set status = "STALE" %}
            {% elif st %}
              {% set sev_upper = (st.last_severity or "")|upper %}
              {% if st.errors_24h > 0 or sev_upper in ("ERROR", "CRITICAL") %}
                {% set status = "ERROR" if sev_upper != "CRITICAL" else "CRITICAL" %}
              {% elif st.warnings_24h > 0 or sev_upper == "WARNING" %}
                {% set status = "WARNING" %}
              {% endif %}
            {% endif %}
            <span class="status-badge sev-{{ status }}">{{ status }}</span>
          </td>
          <td style="font-size:0.85rem;">
            {% if st and st.last_log_update %}{{ st.last_log_update|localtime }}{% else %}<span class="muted">n/a</span>{% endif %}
          </td>
          <td style="text-align:right;">{{ st.errors_24h if st else 0 }}</td>
          <td style="text-align:right;">{{ st.warnings_24h if st else 0 }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted">No modules configured.</p>
  {% endif %}
</div>
{% endblock %}
