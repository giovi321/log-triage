{% extends "base.html" %}
{% block content %}
<div class="card">
  <h2>Edit config.yaml</h2>
  <p class="helper-text">Changes are validated as YAML and saved atomically. A <code>.bak</code> backup is written before replacing the file.</p>
  {% if error %}
    <p style="color:#ff6b6b;">{{ error }}</p>
  {% endif %}
  {% if message %}
    <p style="color:#81c784;">{{ message }}</p>
  {% endif %}
  <form method="post" action="{{ url_for('edit_config_post') }}">
    <div class="editor-layout">
      <div>
        <textarea id="config-text" name="config_text" rows="28" wrap="off" spellcheck="false" style="width:100%; font-family:monospace; font-size:0.95rem; background:#0f131b; border:1px solid #222a38; border-radius:0.65rem; padding:0.75rem;">{{ config_text }}</textarea>
        <div style="margin-top:0.5rem; display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;">
          <button type="submit">Save</button>
          <a class="muted" href="{{ url_for('dashboard') }}">Cancel</a>
          <a class="muted" href="{{ url_for('regex_lab') }}">Regex lab</a>
        </div>
      </div>
      <div class="hint-panel" id="hint-panel">
        <h3>Context hints</h3>
        <div class="hint-body" id="hint-body">Place the cursor in a section to see guidance for that part of the YAML.</div>
      </div>
    </div>
  </form>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css" integrity="sha512-mSC76njgb5Rh1yxTrntHbObr5nyK0pm3PzqzFteXe5EW8trK6GRvtvtnB1ZduGucz3Sgr7vAldqQL5cVVBcHaw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js" integrity="sha512-fNWiaG1Yg+JZSyH3pALwtoSHrCHu6mDGcWhGAdr2X3xpJMMfovMT4MtZP3B+25IVHItlT/zdJpGZc2JkyHG4IQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/yaml/yaml.min.js" integrity="sha512-szXHqFkPU2pPDalJYs5Jj+WZicVQfrv/1S9JQ8lbIlt1RmDE30xH6CR6VGrCvc0Njykg9DrJU0B3zGBgkDcJdA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
  const textarea = document.getElementById('config-text');
  const editor = CodeMirror.fromTextArea(textarea, {
    mode: 'yaml',
    lineNumbers: true,
    lineWrapping: false,
    tabSize: 2,
    indentUnit: 2,
    theme: 'default',
  });

  const hintBody = document.getElementById('hint-body');

  function setHint(text) {
    hintBody.textContent = text;
  }

  function normalizeSegment(raw) {
    return raw.replace(/[^A-Za-z0-9_-]/g, '');
  }

  function pathForCursor(doc, lineNumber) {
    const lines = doc.getValue().split('\n');
    const stack = [];
    for (let i = 0; i <= lineNumber && i < lines.length; i++) {
      const raw = lines[i];
      const indentMatch = raw.match(/^(\s*)/);
      const indent = indentMatch ? indentMatch[1].length : 0;
      const trimmed = raw.trim();
      if (!trimmed || trimmed.startsWith('#')) continue;
      let keyPart = trimmed.startsWith('- ')? trimmed.slice(2).trim() : trimmed;
      const keyMatch = keyPart.match(/^([A-Za-z0-9_-]+):/);
      if (!keyMatch) continue;
      const key = normalizeSegment(keyMatch[1]);
      while (stack.length && stack[stack.length - 1].indent >= indent) {
        stack.pop();
      }
      stack.push({ key, indent });
    }
    return stack.map(s => s.key);
  }

  function hintForPath(parts) {
    if (!parts.length) return 'General settings live here. Click in a section to see focused guidance.';
    const top = parts[0];
    const leaf = parts[parts.length - 1];

    if (top === 'modules') {
      if (leaf === 'mode') return 'module.mode: tail follows a file, stream keeps a reader, journal reads systemd logs, batch consumes JSON batches.';
      if (leaf === 'path') return 'module.path: the log file or directory to read. Ensure permissions allow the logtriage process to read it.';
      if (leaf === 'pipeline_name') return 'module.pipeline_name: must match a pipeline entry. Pipelines define classifiers and grouping rules used for this module.';
      return 'modules: list of inputs. Each module can define name, path, mode, and pipeline_name to tie into classifiers.';
    }
    if (top === 'pipelines') {
      if (leaf === 'classifier') return 'pipelines.classifier: set error_regexes, warning_regexes, and ignore_regexes. Use the Regex Lab to test updates.';
      if (leaf === 'grouping') return 'pipelines.grouping: controls how related lines collapse into events. Tune thresholds to avoid alert floods.';
      return 'pipelines: reusable classifiers and grouping logic referenced by modules via pipeline_name.';
    }
    if (top === 'alerts') {
      return 'alerts: optional sinks (MQTT, webhook, etc.). Disable unused ones to reduce noise and external connections.';
    }
    if (top === 'database') {
      return 'database.url configures where chunks are stored. The Web UI reads stats here; ensure the ingest process uses the same URL.';
    }
    if (top === 'webui') {
      if (leaf === 'secret_key') return 'webui.secret_key: rotate to a long random string. Changing it signs users out.';
      if (leaf === 'allowed_ips') return 'webui.allowed_ips: IP allowlist checked before handling requests. Leave empty to allow all.';
      if (leaf === 'admin_users') return 'webui.admin_users: list of usernames with bcrypt hashes. Update your own hash from the Password page.';
      return 'webui: UI host, port, base path, and security settings. Align these with your reverse proxy if present.';
    }
    if (top === 'baseline') {
      return 'baseline: baseline configuration for anomaly detection. Enable only if you have the model files available.';
    }
    return `${top}: section configuration.`;
  }

  function updateHint() {
    const pos = editor.getCursor();
    const path = pathForCursor(editor, pos.line);
    setHint(hintForPath(path));
  }

  editor.on('cursorActivity', updateHint);
  editor.on('changes', () => editor.save());
  updateHint();
</script>
{% endblock %}
