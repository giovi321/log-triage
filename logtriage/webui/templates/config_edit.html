{% extends "base.html" %}
{% block content %}
<style>
  .config-editor-grid {
    display: grid;
    grid-template-columns: minmax(0, 2.5fr) minmax(320px, 1fr);
    gap: 1.35rem;
    align-items: start;
  }

  @media (max-width: 1080px) {
    .config-editor-grid {
      grid-template-columns: 1fr;
    }
  }

  .config-editor .CodeMirror {
    min-height: 720px;
    height: auto;
    border-radius: 0.75rem;
    box-shadow: inset 0 0 0 1px #222a38;
    background: #0b1020;
  }

  .config-editor .CodeMirror-scroll {
    max-height: none;
  }

  .hint-panel {
    position: sticky;
    top: 1.5rem;
  }

  .hint-panel .hint-body {
    white-space: pre-wrap;
  }

  .client-error {
    color: #ffb4b4;
    background: #2d1a1d;
    border: 1px solid #42232a;
    border-radius: 0.5rem;
    padding: 0.65rem 0.75rem;
    margin-top: 0.6rem;
    display: none;
  }
</style>
<div class="card">
  <h2>Edit config.yaml</h2>
  <p class="helper-text">Changes are validated as YAML and saved atomically. A <code>.bak</code> backup is written before replacing the file.</p>
  {% if error %}
    <p style="color:#ff6b6b;">{{ error }}</p>
  {% endif %}
  {% if message %}
    <p style="color:#81c784;">{{ message }}</p>
  {% endif %}
  <form method="post" action="{{ url_for('edit_config_post') }}" class="config-editor">
    <div class="config-editor-grid">
      <div class="editor-pane">
        <textarea id="config-text" name="config_text" rows="28" wrap="off" spellcheck="false" aria-label="config.yaml editor">{{ config_text }}</textarea>
        <div id="client-error" class="client-error" role="alert"></div>
        <div style="margin-top:0.5rem; display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;">
          <button type="submit">Save</button>
          <a class="muted" href="{{ url_for('dashboard') }}">Cancel</a>
          <a class="muted" href="{{ url_for('regex_lab') }}">Regex lab</a>
        </div>
      </div>
      <div class="hint-panel" id="hint-panel">
        <h3>Context hints</h3>
        <div class="hint-body" id="hint-body">Place the cursor in a section to see guidance for that part of the YAML.</div>
      </div>
    </div>
  </form>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css" integrity="sha512-mSC76njgb5Rh1yxTrntHbObr5nyK0pm3PzqzFteXe5EW8trK6GRvtvtnB1ZduGucz3Sgr7vAldqQL5cVVBcHaw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css" integrity="sha512-FIOh9pI/CeUL8wf8rr1IXYj+WognZ/dRhqEpxP9Iaw7uJLLky54La5QOKxH5YhCmnY4MnBCqYOsk6vtCYsCMwg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js" integrity="sha512-fNWiaG1Yg+JZSyH3pALwtoSHrCHu6mDGcWhGAdr2X3xpJMMfovMT4MtZP3B+25IVHItlT/zdJpGZc2JkyHG4IQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/yaml/yaml.min.js" integrity="sha512-szXHqFkPU2pPDalJYs5Jj+WZicVQfrv/1S9JQ8lbIlt1RmDE30xH6CR6VGrCvc0Njykg9DrJU0B3zGBgkDcJdA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js" integrity="sha512-6xS0dT+Tv1kVqmUoVXOG3GgXBIc+8D8qZjgkI3c5nIEKF0M8qRkK5fVPVIpzANfuCRtBSqD4/YK4JYVU7jzrVA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
  const textarea = document.getElementById('config-text');
  const editor = CodeMirror.fromTextArea(textarea, {
    mode: 'text/x-yaml',
    lineNumbers: true,
    lineWrapping: false,
    tabSize: 2,
    indentUnit: 2,
    theme: 'material-darker',
  });

  editor.getInputField().setAttribute('spellcheck', 'false');
  editor.getInputField().setAttribute('autocorrect', 'off');
  editor.getWrapperElement().style.marginRight = '0.5rem';
  editor.getWrapperElement().style.minHeight = '640px';

  const hintBody = document.getElementById('hint-body');
  const errorBox = document.getElementById('client-error');
  let hintTexts = {};
  let hintsLoaded = false;

  function showClientError(text) {
    errorBox.textContent = text;
    errorBox.style.display = text ? 'block' : 'none';
  }

  function setHint(text) {
    hintBody.textContent = text;
  }

  function normalizeSegment(raw) {
    return raw.replace(/[^A-Za-z0-9_-]/g, '');
  }

  function pathForCursor(doc, lineNumber) {
    const lines = doc.getValue().split('\n');
    const stack = [];
    for (let i = 0; i <= lineNumber && i < lines.length; i++) {
      const raw = lines[i];
      const indentMatch = raw.match(/^(\s*)/);
      const indent = indentMatch ? indentMatch[1].length : 0;
      const trimmed = raw.trim();
      if (!trimmed || trimmed.startsWith('#')) continue;
      let keyPart = trimmed.startsWith('- ')? trimmed.slice(2).trim() : trimmed;
      const keyMatch = keyPart.match(/^([A-Za-z0-9_-]+):/);
      if (!keyMatch) continue;
      const key = normalizeSegment(keyMatch[1]);
      while (stack.length && stack[stack.length - 1].indent >= indent) {
        stack.pop();
      }
      stack.push({ key, indent });
    }
    return stack.map(s => s.key);
  }

  function hintForPath(parts) {
    if (!parts.length) return hintTexts.root || 'Top-level settings for logtriage.';
    const top = parts[0];
    const leaf = parts[parts.length - 1];

    if (top === 'defaults') {
      return hintTexts[`defaults_${leaf}`] || hintTexts.defaults;
    }
    if (top === 'pipelines') {
      if (leaf === 'filename_regex' || leaf === 'match') return hintTexts.pipelines_match;
      if (leaf === 'grouping' || leaf === 'type') return hintTexts.pipelines_grouping;
      if (leaf === 'classifier' || leaf === 'error_regexes' || leaf === 'warning_regexes' || leaf === 'ignore_regexes') return hintTexts.pipelines_classifier;
      if (leaf === 'llm' || leaf === 'prompt_template' || leaf === 'min_severity') return hintTexts.pipelines_llm;
      return hintTexts.pipelines;
    }
    if (top === 'modules') {
      if (leaf === 'path') return hintTexts.modules_path;
      if (leaf === 'mode') return hintTexts.modules_mode;
      if (leaf === 'pipeline' || leaf === 'pipeline_name') return hintTexts.modules_pipeline;
      if (leaf === 'output_format') return hintTexts.modules_output_format;
      if (leaf === 'llm_payload_mode') return hintTexts.modules_llm_payload_mode;
      if (leaf === 'only_last_chunk') return hintTexts.modules_only_last_chunk;
      if (leaf === 'exit_code_by_severity') return hintTexts.modules_exit_code_by_severity;
      if (leaf === 'alerts' || leaf === 'webhook' || leaf === 'mqtt') return hintTexts.modules_alerts;
      if (leaf === 'baseline') return hintTexts.modules_baseline;
      if (leaf === 'stream') return hintTexts.modules_stream;
      return hintTexts.modules;
    }
    if (top === 'database') {
      if (leaf === 'retention_days') return hintTexts.database_retention_days;
      return hintTexts.database;
    }
    if (top === 'webui') {
      if (leaf === 'admin_users') return hintTexts.webui_admin_users;
      if (leaf === 'allowed_ips') return hintTexts.webui_allowed_ips;
      if (leaf === 'secret_key') return hintTexts.webui_secret_key;
      if (leaf === 'session_cookie_name') return hintTexts.webui_session_cookie_name;
      return hintTexts.webui;
    }
    if (top === 'alerts') return hintTexts.alerts;
    if (top === 'baseline') return hintTexts.baseline;
    return `${top}: configuration section.`;
  }

  function updateHint() {
    const pos = editor.getCursor();
    const path = pathForCursor(editor, pos.line);
    const hint = hintForPath(path);
    if (hint) {
      setHint(hint);
    } else {
      setHint(hintsLoaded ? 'No hint available for this section yet.' : 'Loading context hints...');
    }
  }

  function loadHints() {
    const url = '{{ url_for('assets', path='context_hints.json') }}';
    fetch(url)
      .then(resp => resp.json())
      .then(data => {
        hintTexts = data || {};
        hintsLoaded = true;
        updateHint();
      })
      .catch(() => {
        hintTexts = { root: 'Unable to load context hints.' };
        hintsLoaded = false;
        updateHint();
      });
  }

  editor.on('cursorActivity', updateHint);
  editor.on('changes', () => {
    editor.save();
    showClientError('');
  });
  document.querySelector('.config-editor').addEventListener('submit', (event) => {
    const value = editor.getValue();
    try {
      jsyaml.load(value);
      showClientError('');
      editor.save();
    } catch (err) {
      event.preventDefault();
      showClientError(`YAML error: ${err.message}`);
    }
  });
  loadHints();
  updateHint();
</script>
{% endblock %}
