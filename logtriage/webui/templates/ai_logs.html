{% extends "base.html" %}
{% block content %}
<style>
  .log-line { display:flex; align-items:flex-start; gap:0.3rem; padding:0.12rem 0.25rem; }
  .log-line:nth-child(odd) { background:#0d1219; }
  .log-line:nth-child(even) { background:#0f151e; }
  .log-line input[type="checkbox"] { margin-top:0.15rem; flex-shrink:0; }
  .log-line.selected { background:#162032; border-radius:0.4rem; }
  .log-line.finding-line { background:#1a1f2e; }
  .log-line.finding-line:nth-child(odd) { background:#1a1f2e; }
  .log-line.finding-line:nth-child(even) { background:#1c2230; }
  .log-line.finding-line:hover { background:#1f2538; }
  .unified-log-view { max-height:none; overflow:visible; }
  .finding-expand-btn { opacity:0.7; transition:opacity 0.15s; flex-shrink:0; }
  .finding-expand-btn:hover { opacity:1; }
  .finding-expand-btn.expanded { transform:rotate(180deg); }
  .log-section { border-radius:0.35rem; margin-bottom:0; padding:0; background:transparent; }
  .log-section-header { display:flex; gap:0.6rem; align-items:flex-start; justify-content:space-between; padding-bottom:0.25rem; }
  .log-section-body { padding:0; display:flex; flex-direction:column; gap:0; }
  .log-section.collapsed .log-section-body { display:none; }
  .log-section .section-actions { display:flex; gap:0.35rem; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
  .log-section.highlighted-finding { border-color:#4f6fa9; box-shadow:0 0 0 1px #4f6fa9; }
  .finding-response { border-left:3px solid #35517c; border-radius:0.35rem; padding:0.5rem 0.6rem; background:#0f131b; display:flex; flex-direction:column; gap:0.3rem; }
  .finding-response + .finding-response { margin-top:0.65rem; }
  .finding-response h4 { margin:0; font-size:1rem; display:flex; gap:0.4rem; align-items:center; flex-wrap:wrap; }
  .finding-response .llm-body { max-height:180px; overflow:auto; background:#0c1018; padding:0.5rem; border-radius:0.5rem; white-space:pre-wrap; }
  .synced-shell { border-radius:0.5rem; padding:0.35rem; background:#0a0e14; }
  .synced-scroll { display:flex; flex-direction:column; gap:0; max-height:380px; overflow-y:auto; padding-right:0; }
  .synced-row { display:flex; flex-direction:column; gap:0; }
  .synced-pane { border-radius:0; background:transparent; padding:0; }
  .match-highlight { background:#3d2a0a; color:#f5c842; padding:0 0.1rem; border-radius:0.15rem; }
  .sort-toggle { margin-left:auto; display:flex; align-items:center; gap:0.35rem; }
  .sort-toggle button { padding:0.25rem 0.6rem; font-size:0.85rem; }
  .sort-toggle button.active { background:#2e4472; border-color:#3c5c98; }
  .sync-title { display:flex; align-items:center; justify-content:space-between; gap:0.5rem; flex-wrap:wrap; }
  .finding-controls { display:flex; gap:0.35rem; flex-wrap:wrap; align-items:center; margin-top:0.3rem; }
  .finding-controls form { display:inline-flex; gap:0.25rem; align-items:center; margin:0; }
  .finding-controls select { min-width:120px; }
  .log-actions { display:flex; gap:0.45rem; flex-wrap:wrap; margin-bottom:0.35rem; }
  .log-actions { align-items:center; flex-wrap:nowrap; overflow-x:auto; overflow-y:visible; padding-bottom:0.15rem; position:relative; z-index:950; }
  .log-actions > * { white-space:nowrap; }
  .context-toggle { display:flex; align-items:center; gap:0.35rem; padding:0.25rem 0.45rem; background:#0f131b; border:1px solid #1f2635; border-radius:0.45rem; }
  .context-toggle .chip-group { display:inline-flex; gap:0.3rem; }
  .context-toggle button { padding:0.3rem 0.6rem; border-radius:0.4rem; background:#182033; border:1px solid #27324a; color:#dfe7f4; }
  .context-toggle button.active { background:#2e4472; border-color:#3c5c98; }
  .selection-box { display:flex; align-items:center; gap:0.35rem; position:relative; z-index:1100; padding:0.25rem 0.45rem; background:#0f131b; border:1px solid #1f2635; border-radius:0.45rem; }
  .selection-box .muted { font-size:0.9rem; }
  .action-menu { position:relative; z-index:1200; }
  .action-menu button.menu-trigger { display:inline-flex; align-items:center; gap:0.35rem; }
  .action-menu .menu-panel { position:fixed; right:0; top:0; background:#0f131b; border:1px solid #2b3242; border-radius:0.4rem; padding:0.35rem; box-shadow:0 10px 26px rgba(0,0,0,0.35); min-width:0; display:none; z-index:1800; }
  .action-menu.open .menu-panel { display:flex; flex-wrap:wrap; gap:0.3rem; }
  .action-menu .menu-panel button { flex:1 1 auto; min-width:90px; justify-content:center; background:transparent; border:1px solid #2b3242; color:#e8ecf2; box-shadow:none; }
  .action-menu .menu-panel button:hover { background:#1b2234; }
  .action-menu .menu-panel button:focus { outline:none; box-shadow:0 0 0 1px #2f3b53; }
  button.danger { background:#7d3434; border:1px solid #a35f5f; color:#f8eaea; box-shadow:none; }
  .llm-workbench { margin-top:1rem; border:1px solid #1a2232; border-radius:0.75rem; padding:0.8rem; background:#0c111a; display:flex; flex-direction:column; gap:0.65rem; }
  .prompt-grid { grid-template-columns: 1.05fr 0.95fr; gap:0.75rem; align-items:stretch; }
  .prompt-grid textarea { height:240px; }
  .prompt-panel { border:1px solid #2b3242; border-radius:0.6rem; background:#0f131b; padding:0.65rem; display:flex; flex-direction:column; gap:0.4rem; height:100%; }
  .prompt-shell { display:flex; flex-direction:column; gap:0.35rem; height:100%; }
  .llm-fixed-response { border:1px solid #2b3242; border-radius:0.6rem; background:#0f131b; padding:0.65rem; height:240px; overflow-y:auto; white-space:pre-wrap; }
  .prompt-title { display:flex; align-items:center; justify-content:space-between; font-weight:600; margin:0; }
  .false-positive-overlay { position:fixed; inset:0; background:rgba(4,7,12,0.78); display:none; align-items:center; justify-content:center; z-index:5000; padding:1.5rem; }
  .false-positive-panel { background:#0e131d; border:1px solid #1f2a3c; border-radius:0.85rem; padding:1rem; width:min(1320px, 98vw); max-height:88vh; overflow:auto; box-shadow:0 18px 48px rgba(0,0,0,0.45); display:flex; flex-direction:column; gap:0.85rem; }
  .false-positive-grid { display:grid; grid-template-columns:1.1fr 0.9fr; gap:0.85rem; align-items:start; }
  @media (max-width: 980px) { .false-positive-grid { grid-template-columns:1fr; } }
  .false-positive-line { border:1px solid #1d2738; border-radius:0.65rem; padding:0.65rem; background:#0c1119; font-family:monospace; white-space:pre-wrap; word-break:break-word; min-height:72px; }
  .false-positive-line.regex-match { box-shadow:0 0 0 1px #3c6acb; background:#101a2c; }
  .false-positive-line .match-highlight { background:#332107; padding:0.05rem 0.15rem; border-radius:0.25rem; }
  .false-positive-presets { display:flex; flex-wrap:wrap; gap:0.35rem; }
  .false-positive-presets button { background:#162237; border:1px solid #2d3c56; box-shadow:none; color:#e7ecf4; }
  .false-positive-presets button:hover { background:#1f2f4d; }
  .false-positive-actions { display:flex; align-items:center; justify-content:space-between; gap:0.75rem; flex-wrap:wrap; }
</style>
  <div class="card">
  <div style="display:flex; justify-content:space-between; align-items:center; gap:0.75rem; flex-wrap:wrap; margin-bottom:0.75rem;">
    <form method="get" action="{{ url_for('ai_logs') }}" style="display:flex; gap:0.75rem; flex-wrap:wrap; align-items:center;">
      <label>Module:
        <select name="module" onchange="this.form.submit()">
          {% for m in modules|sort(attribute='name') %}{% if m.enabled %}
            <option value="{{ m.name }}" {% if current_module and m.name == current_module.name %}selected{% endif %}>{{ m.name }}</option>
          {% endif %}{% endfor %}
        </select>
      </label>
      <label>Tail view:
        <select name="tail_filter" onchange="this.form.submit()">
          <option value="all" {% if tail_filter == 'ALL' %}selected{% endif %}>All lines</option>
          {% for sev in tail_severities %}
            <option value="{{ sev }}" {% if tail_filter == sev %}selected{% endif %}>{{ sev }} only</option>
          {% endfor %}
        </select>
      </label>
      <input type="hidden" name="issue_filter" value="all">
      <input type="hidden" name="sample_source" value="{{ sample_source }}">
      <span class="muted">Path: {{ current_module.path if current_module else '-' }}</span>
    </form>
    {% if current_module %}
      {% set st = stats.get(current_module.name) if stats else None %}
      {% set status = "OK" %}
      {% if ingestion_status and current_module.name in ingestion_status.stale_modules %}
        {% set status = "STALE" %}
      {% elif st %}
        {% set sev_upper = (st.last_severity or "")|upper %}
        {% if st.errors_24h > 0 or sev_upper in ("ERROR", "CRITICAL") %}
          {% set status = "ERROR" if sev_upper != "CRITICAL" else "CRITICAL" %}
        {% elif st.warnings_24h > 0 or sev_upper == "WARNING" %}
          {% set status = "WARNING" %}
        {% endif %}
      {% endif %}
      <div style="display:flex; gap:0.75rem; align-items:center; flex-wrap:wrap; margin-left:auto;">
        <div style="display:flex; gap:0.45rem; align-items:center; flex-wrap:wrap;">
          <span class="muted">Last log update</span>
          {% if st and st.last_log_update %}
            <span class="status-chip">{{ st.last_log_update|localtime }}</span>
          {% else %}
            <span class="muted">n/a</span>
          {% endif %}
          <span class="status-badge sev-{{ status }}">{{ status }}</span>
        </div>
        <div style="display:flex; gap:0.4rem; align-items:center; flex-wrap:wrap;">
          <span class="muted">Open findings</span>
          {% if open_findings_count is not none %}
            <span class="status-chip">{{ open_findings_count }}</span>
          {% else %}
            <span class="muted">n/a</span>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>

  {% if not modules %}
    <p class="muted">No modules configured yet.</p>
  {% elif not current_module %}
    <p class="muted">Select a module to view its logs.</p>
  {% else %}
      <div class="log-actions" style="margin-bottom:0.6rem;">
        <div class="selection-box">
          <span class="muted">Selected:</span>
          <button type="button" class="secondary" id="select-all-lines" onclick="toggleSelectAllLines()">Select all</button>
          <button type="button" class="secondary" onclick="copySelectedLines()">Copy</button>
          <div class="action-menu" id="mark-finding-menu">
            <button type="button" class="secondary menu-trigger" id="mark-finding-trigger" aria-haspopup="true" aria-expanded="false" onclick="toggleSeverityMenu()" {% if not current_module or not db_status.connected %}disabled{% endif %}>
              <span id="mark-finding-label">Mark as finding</span>
            </button>
            <div class="menu-panel" id="mark-finding-panel" role="menu" aria-label="Choose severity">
              <div id="already-finding-msg" style="display:none; padding:0.5rem; color:#9fb1d3; font-size:0.9rem; white-space:nowrap;">This line is already a finding</div>
              {% for sev in severity_choices %}
                <button type="button" class="secondary" role="menuitem" onclick="submitManualFinding('{{ sev }}')">{{ sev }}</button>
              {% endfor %}
              {% if not severity_choices %}
                <button type="button" class="secondary" role="menuitem" onclick="submitManualFinding('ERROR')">ERROR</button>
              {% endif %}
            </div>
          </div>
          <button type="button" class="danger" onclick="deleteSelectedFindings()" {% if not current_module or not db_status.connected %}disabled{% endif %}>Delete findings</button>
        </div>
        <div class="selection-box" style="flex:1; min-width:180px;">
          <input type="text" id="fuzzy-search" placeholder="Search lines..." style="flex:1; min-width:100px; padding:0.3rem 0.5rem; border:1px solid #2b3242; border-radius:0.35rem; background:#0f131b; color:#e8ecf2;" oninput="filterLinesBySearch()">
          <button type="button" class="secondary" onclick="clearSearch()">Clear</button>
        </div>
        <div class="sort-toggle">
          <button type="button" class="secondary sort-btn active" data-order="newest" onclick="setLogSort('newest')">Newest first</button>
          <button type="button" class="secondary sort-btn" data-order="oldest" onclick="setLogSort('oldest')">Oldest first</button>
        </div>
        {% if sample_start_line > 1 and tail_filter == 'ALL' %}
          <button type="button" class="secondary" id="load-more-btn" onclick="loadMoreLines()" style="padding:0.35rem 0.75rem;">Load older lines</button>
        {% endif %}
      <form id="manual-finding-form" method="post" action="{{ url_for('create_manual_finding') }}" style="display:none;">
        <input type="hidden" name="severity" id="manual-finding-severity" value="{{ severity_choices[0] if severity_choices else 'ERROR' }}">
          <input type="hidden" name="module" value="{{ current_module.name if current_module else '' }}">
          <input type="hidden" name="tail_filter" value="{{ tail_filter }}">
          <input type="hidden" name="issue_filter" value="{{ issue_filter }}">
          <input type="hidden" name="sample_source" value="{{ sample_source }}">
          <input type="hidden" name="lines" id="manual-finding-lines">
          <input type="hidden" name="line_indexes" id="manual-finding-indexes">
        </form>
      {% if issue_filter != 'ALL' %}
        <a href="{{ url_for('ai_logs') }}?module={{ current_module.name }}{% if tail_filter %}&tail_filter={{ tail_filter|lower }}{% endif %}&sample_source={{ sample_source }}" style="display:inline-flex; align-items:center; padding:0.45rem 0.65rem; border:1px solid #2b3242; border-radius:0.35rem; text-decoration:none; color:#e8ecf2;">Reset issue filter</a>
      {% endif %}
      {% if tail_filter != 'ALL' %}
        <a href="{{ url_for('ai_logs') }}?module={{ current_module.name }}{% if issue_filter %}&issue_filter={{ issue_filter|lower }}{% endif %}&sample_source={{ sample_source }}" style="display:inline-flex; align-items:center; padding:0.45rem 0.65rem; border:1px solid #2b3242; border-radius:0.35rem; text-decoration:none; color:#e8ecf2;">Reset tail filter</a>
      {% endif %}
    </div>
    <form id="delete-selected-findings-form" method="post" action="{{ url_for('delete_selected_findings') }}" style="display:none;">
      <input type="hidden" name="module" value="{{ current_module.name if current_module else '' }}">
      <input type="hidden" name="tail_filter" value="{{ tail_filter }}">
      <input type="hidden" name="issue_filter" value="{{ issue_filter }}">
      <input type="hidden" name="sample_source" value="{{ sample_source }}">
      <input type="hidden" name="finding_ids" id="selected-finding-ids">
    </form>
    <div class="synced-shell">
      <div class="synced-scroll" id="synced-scroll">
        {% if sample_lines %}
          {% if finding_tail %}
            {% for section in finding_tail %}
              {% if section.unified_view %}
                {# Unified view: all lines shown together with findings inline #}
                <div class="synced-row">
                  <div class="synced-pane tail-pane" style="width:100%;">
                    <div class="log-section unified-log-view">
                      <div class="log-section-body">
                        {% for line in section.lines %}
                          {% set line_finding = line.finding %}
                          <div class="log-line {% if line_finding %}finding-line{% endif %}" style="font-family:monospace; font-size:0.92rem;" data-line-index="{{ line.index }}" {% if line_finding and line_finding.id %}data-finding-section="true" data-finding-id="{{ line_finding.id }}" data-finding-index="{{ line_finding.finding_index }}" data-rule-id="{{ line_finding.rule_id|default('', true)|e }}"{% endif %}>
                            <input type="checkbox" name="selected_line" value="{{ line.index }}" data-line-index="{{ line.index }}" data-line="{{ line.text|replace('\n','')|e }}" {% if line_finding and line_finding.id %}data-finding-id="{{ line_finding.id }}"{% endif %}>
                            <span style="min-width:2.5rem; color:#9fb1d3; flex-shrink:0;">{{ line.index }}:</span>
                            {% if line_finding %}
                              <span class="status-badge sev-{{ line_finding.severity }}" style="font-size:0.7rem; padding:0.1rem 0.35rem; margin-right:0.35rem;">{{ line_finding.severity }}</span>
                            {% endif %}
                            <span class="log-line-text" style="flex:1; white-space:pre-wrap; word-break:break-word;">{{ line.text }}</span>
                            {% if line_finding %}
                              <button type="button" class="secondary finding-expand-btn" style="padding:0.15rem 0.4rem; font-size:0.75rem; margin-left:0.35rem;" onclick="toggleFindingDetails('{{ line_finding.id }}')">▼</button>
                            {% endif %}
                          </div>
                          {% if line_finding %}
                            <div class="finding-details" id="finding-details-{{ line_finding.id }}" style="display:none; margin-left:4rem; margin-bottom:0.5rem; padding:0.5rem; background:#0c1119; border-radius:0.4rem; border-left:3px solid #4f6fa9;">
                              <div style="display:flex; gap:0.45rem; align-items:flex-start; flex-wrap:wrap; margin-bottom:0.35rem;">
                                <div style="display:flex; flex-direction:column; gap:0.15rem; flex:1;">
                                  <span class="muted" style="font-size:0.85rem;">Finding #{{ line_finding.finding_index }} · {{ line_finding.created_at|localtime }}</span>
                                  <span class="helper-text" style="margin:0;">{{ line_finding.reason }}</span>
                                </div>
                                <div class="finding-controls" style="margin:0; flex-shrink:0;">
                                {% set finding_example = (finding_examples.get(line_finding.id) if finding_examples else None) %}
                                {% if providers %}
                                <button type="button" class="secondary" onclick="queryLLMForFinding('{{ line_finding.id }}')">Query LLM</button>
                                {% endif %}
                                <form method="post" action="{{ url_for('mark_false_positive') }}" class="false-positive-form">
                                  <input type="hidden" name="finding_id" value="{{ line_finding.id }}">
                                  <input type="hidden" name="module" value="{{ current_module.name }}">
                                  <input type="hidden" name="tail_filter" value="{{ tail_filter }}">
                                  <input type="hidden" name="issue_filter" value="{{ issue_filter }}">
                                  <input type="hidden" name="sample_line" value="{{ (finding_example or line_finding.reason)|e }}">
                                  <input type="hidden" name="sample_source" value="{{ sample_source }}">
                                  <button type="button" class="secondary" onclick="launchFalsePositiveFlow(this.form)">False positive</button>
                                </form>
                                <form method="post" action="{{ url_for('change_finding_severity') }}" id="finding-severity-form-{{ line_finding.id }}">
                                  <input type="hidden" name="finding_id" value="{{ line_finding.id }}">
                                  <input type="hidden" name="module" value="{{ current_module.name }}">
                                  <input type="hidden" name="tail_filter" value="{{ tail_filter }}">
                                  <input type="hidden" name="issue_filter" value="{{ issue_filter }}">
                                  <input type="hidden" name="sample_source" value="{{ sample_source }}">
                                  <input type="hidden" name="severity" id="finding-severity-value-{{ line_finding.id }}" value="{{ line_finding.severity if line_finding.severity in severity_choices else (severity_choices[0] if severity_choices else 'ERROR') }}">
                                  <div class="action-menu finding-severity-menu" id="finding-sev-menu-{{ line_finding.id }}" data-finding-id="{{ line_finding.id }}">
                                    <button type="button" class="secondary menu-trigger" id="finding-sev-trigger-{{ line_finding.id }}" aria-haspopup="true" aria-expanded="false" onclick="toggleFindingSeverityMenu('{{ line_finding.id }}')">
                                      Update severity
                                    </button>
                                    <div class="menu-panel" id="finding-sev-panel-{{ line_finding.id }}" role="menu" aria-label="Choose severity for finding {{ line_finding.finding_index }}">
                                      {% for sev in severity_choices %}
                                        <button type="button" class="secondary" role="menuitem" onclick="submitFindingSeverity('{{ line_finding.id }}', '{{ sev }}')">{{ sev }}</button>
                                      {% endfor %}
                                    </div>
                                  </div>
                                </form>
                                </div>
                              </div>
                              {# AI opinion inline #}
                              {% set response_obj = line_finding|attr('llm_response') %}
                              {% set response_content = response_obj.content if response_obj else line_finding|attr('llm_response_content') %}
                              {% set response_provider = response_obj.provider if response_obj else line_finding|attr('llm_provider') %}
                              {% set response_model = response_obj.model if response_obj else line_finding|attr('llm_model') %}
                              {% set response_error = line_finding|attr('llm_error') %}
                              {% if response_content %}
                                <div class="finding-response" style="margin-top:0.5rem;" data-finding-summary="true" data-finding-id="{{ line_finding.id }}">
                                  {% if response_provider or response_model %}
                                    <div class="helper-text" style="margin:0;">AI opinion: {{ response_provider or 'Unknown provider' }}{% if response_model %} · {{ response_model }}{% endif %}</div>
                                  {% endif %}
                                  <div class="llm-body" style="max-height:120px;">{{ response_content }}</div>
                                  <div class="recorded-summary muted" data-summary-for="{{ line_finding.id }}" style="display:none;"></div>
                                </div>
                              {% elif response_error %}
                                <div class="finding-response" style="margin-top:0.5rem; border-left:3px solid #b94a4a;" data-finding-summary="true" data-finding-id="{{ line_finding.id }}">
                                  <div class="helper-text" style="margin:0;">AI error</div>
                                  <div class="llm-body" style="max-height:120px;">{{ response_error }}</div>
                                </div>
                              {% endif %}
                            </div>
                          {% endif %}
                        {% endfor %}
                      </div>
                    </div>
                  </div>
                </div>
              {% else %}
                {# Legacy section view (fallback) #}
                <div class="synced-row">
                  <div class="synced-pane tail-pane">
                    <div class="log-section" {% if section.finding %}data-finding-section="true" data-finding-id="{{ section.finding.id }}" data-finding-index="{{ section.finding.finding_index }}"{% endif %}>
                      <div class="log-section-header">
                        {% if section.finding %}
                          <div style="display:flex; gap:0.45rem; align-items:flex-start; flex-wrap:wrap;">
                            <span class="status-badge sev-{{ section.finding.severity }}">{{ section.finding.severity }}</span>
                            <div style="display:flex; flex-direction:column; gap:0.15rem; min-width:12rem;">
                              <span class="muted" style="font-size:0.85rem;">Finding #{{ section.finding.finding_index }} · {{ section.finding.created_at|localtime }}</span>
                              <span class="helper-text" style="margin:0;">{{ section.finding.reason }}</span>
                            </div>
                          </div>
                        {% else %}
                          <div class="muted">Tail lines</div>
                        {% endif %}
                      </div>
                      <div class="log-section-body">
                        {% for line in section.lines %}
                          <div class="log-line" style="font-family:monospace; font-size:0.92rem;" data-line-index="{{ line.index }}">
                            <input type="checkbox" name="selected_line" value="{{ line.index }}" data-line-index="{{ line.index }}" data-line="{{ line.text|replace('\n','')|e }}">
                            <span style="min-width:2.5rem; color:#9fb1d3; flex-shrink:0;">{{ line.index }}:</span>
                            <span style="flex:1; white-space:pre-wrap; word-break:break-word;">{{ line.text }}</span>
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          {% elif had_finding_tail and (tail_filter != 'ALL' or issue_filter != 'ALL') %}
            <div class="synced-row">
              <div class="synced-pane tail-pane" style="width:100%;">
                <p class="muted">No log sections matched the current filters.</p>
              </div>
            </div>
          {% else %}
            <div class="synced-row">
              <div class="synced-pane tail-pane" style="width:100%;">
                {% for line in sample_lines %}
                  <div class="log-line" style="font-family:monospace; font-size:0.92rem;">
                    <input type="checkbox" name="selected_line" data-line-index="{{ loop.index0 }}" data-line="{{ line|replace('\n','')|e }}">
                    <span style="flex:1; white-space:pre-wrap; word-break:break-word;">{{ line }}</span>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        {% else %}
          <div class="synced-row">
            <div class="synced-pane tail-pane" style="width:100%;">
              <p class="muted">No lines read from this log path.</p>
            </div>
          </div>
        {% endif %}
      </div>
      </div>
    </div>

    {% if providers %}
    <div class="llm-workbench">
      <div class="prompt-panel">
        <div class="prompt-title">
          <span>LLM Analysis</span>
          <span id="llm-status" class="muted"></span>
        </div>
        <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-top:0.15rem;">
          <label style="display:flex; align-items:center; gap:0.5rem;">
            Provider:
            <select id="llm-provider">
              {% for p in providers %}
                <option value="{{ p.name }}" {% if selected_provider and p.name == selected_provider %}selected{% endif %}>{{ p.name }} ({{ p.model }})</option>
              {% endfor %}
            </select>
          </label>
        </div>
        <div id="provider-hints" class="helper-text"></div>
      </div>
      <div class="prompt-panel">
        <div class="prompt-title" style="margin-bottom:0.3rem;">AI Response</div>
        <div id="llm-response" class="llm-fixed-response muted">Select a finding and click "Query LLM" to get AI analysis.</div>
        <div id="llm-usage" class="helper-text" style="margin-top:0.25rem;"></div>
        <div id="llm-citations" class="helper-text" style="margin-top:0.25rem;"></div>
        <div style="display:flex; gap:0.5rem; flex-wrap:wrap; justify-content:flex-end; margin-top:0.35rem;">
          <button type="button" class="secondary" onclick="attachOpinionToSelectedFinding()">Attach AI opinion to selected finding</button>
          <button type="button" class="secondary" onclick="summarizeAndRecord()">Summarize & record for entry</button>
        </div>
      </div>
    </div>
  {% else %}
    <p class="muted">No providers configured. Update config.yaml to add entries under llm.providers.</p>
  {% endif %}
{% endif %}
</div>

<div id="false-positive-overlay" class="false-positive-overlay" aria-hidden="true">
  <div class="false-positive-panel" role="dialog" aria-modal="true" aria-labelledby="false-positive-title">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:0.75rem; flex-wrap:wrap;">
      <div>
        <h3 id="false-positive-title" style="margin:0;">Mark finding as false positive</h3>
        <p id="false-positive-guidance" class="helper-text" style="margin:0.2rem 0 0;">We will add a regex to the classifier's ignore list and remove this finding from the feed.</p>
      </div>
      <button type="button" class="secondary" onclick="closeFalsePositiveFlow()">Close</button>
    </div>
    <div class="false-positive-grid">
      <div>
        <div class="helper-text" style="margin-bottom:0.35rem;">Lines to ignore</div>
        <div id="false-positive-line" class="false-positive-line" data-full-line=""></div>
        <button type="button" class="secondary" style="margin-top:0.45rem;" onclick="useHighlightedTextForRegex()">Use highlighted text to build regex</button>
      </div>
      <div>
        <div style="display:flex; flex-direction:column; gap:0.35rem;">
          <label style="margin:0; display:flex; flex-direction:column; gap:0.25rem;">
            <span class="helper-text">Build your ignore regex</span>
            <textarea id="false-positive-regex" rows="4" style="width:100%; font-family:monospace;"></textarea>
          </label>
          <div class="false-positive-presets" id="false-positive-presets"></div>
        </div>
        <div style="display:flex; align-items:center; justify-content:space-between; gap:0.65rem; flex-wrap:wrap; margin-top:0.45rem;">
          <div id="false-positive-test-result" class="helper-text" style="margin:0;"></div>
          <button type="button" class="secondary" onclick="testFalsePositiveRegex()">Test against this line</button>
        </div>
      </div>
    </div>
    <div class="false-positive-actions">
      <div id="false-positive-next" class="helper-text">Saving will remove the finding and store the ignore regex in your classifier config.</div>
      <div style="display:flex; gap:0.5rem; flex-wrap:wrap; justify-content:flex-end; align-items:center;">
        <button type="button" class="secondary" onclick="closeFalsePositiveFlow()">Cancel</button>
        <button type="button" onclick="submitFalsePositive()">Save ignore rule</button>
      </div>
    </div>
  </div>
</div>

<form id="false-positive-hidden-form" method="post" action="{{ url_for('mark_false_positive') }}" style="display:none;">
  <input type="hidden" name="finding_id">
  <input type="hidden" name="module" value="{{ current_module.name if current_module else '' }}">
  <input type="hidden" name="tail_filter" value="{{ tail_filter }}">
  <input type="hidden" name="issue_filter" value="{{ issue_filter }}">
  <input type="hidden" name="sample_source" value="{{ sample_source }}">
  <input type="hidden" name="sample_line">
  <input type="hidden" name="regex_value">
</form>

<script type="application/json" id="provider-settings-json">{{ provider_settings|tojson }}</script>
<script type="application/json" id="module-prompt-template-json">{{ module_prompt_template|tojson }}</script>
<script type="application/json" id="summary-prompt-template-json">{{ summary_prompt_template|tojson }}</script>
<script type="application/json" id="regex-presets-json">{{ regex_presets|tojson }}</script>
<script type="application/json" id="pagination-state-json">{{ {
  'currentModule': (current_module.name if current_module else ''),
  'sampleSource': sample_source,
  'currentOffset': (sample_lines|length),
  'startLine': sample_start_line,
  'totalLines': total_lines,
  'hasMore': (true if sample_start_line > 1 else false)
}|tojson }}</script>

<script>
  /* eslint-disable */
  const providerSettings = JSON.parse((document.getElementById('provider-settings-json') || {}).textContent || '{}');
  const modulePromptTemplate = JSON.parse((document.getElementById('module-prompt-template-json') || {}).textContent || 'null');
  const summaryPromptTemplate = JSON.parse((document.getElementById('summary-prompt-template-json') || {}).textContent || 'null');
  const regexPresets = JSON.parse((document.getElementById('regex-presets-json') || {}).textContent || '{}');
  const SUMMARY_PLACEHOLDER = '{' + '{' + 'AI_OPINION' + '}' + '}';
  const recordedSummaries = {};

  // Pagination state
  const paginationStateInit = JSON.parse((document.getElementById('pagination-state-json') || {}).textContent || '{}');
  const paginationState = Object.assign({ loading: false }, paginationStateInit || {});

  let lastLLMData = null;
  let activeFalsePositiveForm = null;

  function toggleFindingDetails(findingId) {
    const details = document.getElementById(`finding-details-${findingId}`);
    const btn = document.querySelector(`[onclick="toggleFindingDetails('${findingId}')"]`);
    if (!details) return;
    const isVisible = details.style.display !== 'none';
    details.style.display = isVisible ? 'none' : 'block';
    if (btn) {
      btn.classList.toggle('expanded', !isVisible);
    }
  }

  async function loadMoreLines() {
    if (paginationState.loading || !paginationState.hasMore) return;
    
    const btn = document.getElementById('load-more-btn');
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'Loading...';
    }
    paginationState.loading = true;

    try {
      const params = new URLSearchParams({
        module: paginationState.currentModule,
        offset: paginationState.currentOffset,
        limit: 500,
        sample_source: paginationState.sampleSource
      });
      
      /* eslint-disable */
      const resp = await fetch(`{{ url_for('api_log_lines') }}?${params}`);
      /* eslint-enable */
      const data = await resp.json();
      
      if (!resp.ok) {
        throw new Error(data.error || 'Failed to load more lines');
      }

      // Insert new lines at the beginning of the log section
      const container = document.querySelector('.log-section-body');
      if (container && data.lines && data.lines.length > 0) {
        // Create document fragment for efficient DOM insertion
        const fragment = document.createDocumentFragment();
        
        // Process lines in reverse order since we're prepending
        for (let i = data.lines.length - 1; i >= 0; i--) {
          const lineData = data.lines[i];
          const lineEl = createLogLineElement(lineData);
          fragment.insertBefore(lineEl, fragment.firstChild);
          
          // If line has a finding, create the details element too
          if (lineData.finding) {
            const detailsEl = createFindingDetailsElement(lineData);
            // Insert details right after the line
            const nextSibling = lineEl.nextSibling;
            if (nextSibling) {
              fragment.insertBefore(detailsEl, nextSibling);
            } else {
              fragment.appendChild(detailsEl);
            }
          }
        }
        
        // Insert at the beginning of the container
        container.insertBefore(fragment, container.firstChild);
        
        // Re-sort if needed
        sortLogLines();
        
        // Highlight regex matches on new lines
        highlightRegexMatches();
        
        // Rebind checkbox listeners
        document.querySelectorAll('input[name="selected_line"]').forEach(cb => {
          cb.removeEventListener('change', refreshSelectedHighlights);
          cb.addEventListener('change', refreshSelectedHighlights);
        });
      }

      // Update pagination state
      paginationState.currentOffset = data.next_offset;
      paginationState.startLine = data.start_line;
      paginationState.hasMore = data.has_more;

      // Update button text or hide it
      if (btn) {
        if (data.has_more) {
          btn.textContent = 'Load older lines';
          btn.disabled = false;
        } else {
          btn.parentElement.innerHTML = `<span class="muted">Showing all lines</span>`;
        }
      }
    } catch (err) {
      console.error('Error loading more lines:', err);
      if (btn) {
        btn.textContent = 'Error loading lines. Click to retry.';
        btn.disabled = false;
      }
    } finally {
      paginationState.loading = false;
    }
  }

  function createLogLineElement(lineData) {
    const div = document.createElement('div');
    div.className = 'log-line' + (lineData.finding ? ' finding-line' : '');
    div.style.cssText = 'font-family:monospace; font-size:0.92rem;';
    div.dataset.lineIndex = lineData.index;
    
    if (lineData.finding) {
      div.dataset.findingSection = 'true';
      div.dataset.findingId = lineData.finding.id;
      div.dataset.findingIndex = lineData.finding.finding_index;
      if (lineData.finding.rule_id) {
        div.dataset.ruleId = lineData.finding.rule_id;
      }
    }

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.name = 'selected_line';
    checkbox.value = lineData.index;
    checkbox.dataset.lineIndex = lineData.index;
    checkbox.dataset.line = (lineData.text || '').replace(/\n/g, '');
    if (lineData.finding) {
      checkbox.dataset.findingId = lineData.finding.id;
    }
    div.appendChild(checkbox);

    const lineNum = document.createElement('span');
    lineNum.style.cssText = 'min-width:2.5rem; color:#9fb1d3; flex-shrink:0;';
    lineNum.textContent = `${lineData.index}:`;
    div.appendChild(lineNum);

    if (lineData.finding) {
      const badge = document.createElement('span');
      badge.className = `status-badge sev-${lineData.finding.severity}`;
      badge.style.cssText = 'font-size:0.7rem; padding:0.1rem 0.35rem; margin-right:0.35rem;';
      badge.textContent = lineData.finding.severity;
      div.appendChild(badge);
    }

    const textSpan = document.createElement('span');
    textSpan.className = 'log-line-text';
    textSpan.style.cssText = 'flex:1; white-space:pre-wrap; word-break:break-word;';
    textSpan.textContent = lineData.text || '';
    div.appendChild(textSpan);

    if (lineData.finding) {
      const expandBtn = document.createElement('button');
      expandBtn.type = 'button';
      expandBtn.className = 'secondary finding-expand-btn';
      expandBtn.style.cssText = 'padding:0.15rem 0.4rem; font-size:0.75rem; margin-left:0.35rem;';
      expandBtn.textContent = '▼';
      expandBtn.onclick = () => toggleFindingDetails(lineData.finding.id);
      div.appendChild(expandBtn);
      
      // Add double-click handler
      div.addEventListener('dblclick', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;
        toggleFindingDetails(lineData.finding.id);
      });
    }

    return div;
  }

  function createFindingDetailsElement(lineData) {
    const finding = lineData.finding;
    const div = document.createElement('div');
    div.className = 'finding-details';
    div.id = `finding-details-${finding.id}`;
    div.style.cssText = 'display:none; margin-left:4rem; margin-bottom:0.5rem; padding:0.5rem; background:#0c1119; border-radius:0.4rem; border-left:3px solid #4f6fa9;';

    let html = `
      <div style="display:flex; gap:0.45rem; align-items:flex-start; flex-wrap:wrap; margin-bottom:0.35rem;">
        <div style="display:flex; flex-direction:column; gap:0.15rem; flex:1;">
          <span class="muted" style="font-size:0.85rem;">Finding #${finding.finding_index} · ${finding.created_at}</span>
          <span class="helper-text" style="margin:0;">${escapeHtml(finding.reason || '')}</span>
        </div>
      </div>
    `;

    if (finding.llm_response_content) {
      html += `
        <div class="finding-response" style="margin-top:0.5rem;" data-finding-summary="true" data-finding-id="${finding.id}">
          ${finding.llm_provider || finding.llm_model ? `<div class="helper-text" style="margin:0;">AI opinion: ${finding.llm_provider || 'Unknown provider'}${finding.llm_model ? ` · ${finding.llm_model}` : ''}</div>` : ''}
          <div class="llm-body" style="max-height:120px;">${escapeHtml(finding.llm_response_content)}</div>
          <div class="recorded-summary muted" data-summary-for="${finding.id}" style="display:none;"></div>
        </div>
      `;
    } else if (finding.llm_error) {
      html += `
        <div class="finding-response" style="margin-top:0.5rem; border-left:3px solid #b94a4a;" data-finding-summary="true" data-finding-id="${finding.id}">
          <div class="helper-text" style="margin:0;">AI error</div>
          <div class="llm-body" style="max-height:120px;">${escapeHtml(finding.llm_error)}</div>
        </div>
      `;
    }

    div.innerHTML = html;
    return div;
  }

  function sortLogLines() {
    const activeBtn = document.querySelector('.sort-btn.active');
    const container = document.querySelector('.log-section-body');
    if (!activeBtn || !container) return;
    
    const sortOrder = activeBtn.dataset.order || 'newest';
    const lines = Array.from(container.querySelectorAll('.log-line'));
    
    lines.sort((a, b) => {
      const indexA = parseInt(a.dataset.lineIndex, 10) || 0;
      const indexB = parseInt(b.dataset.lineIndex, 10) || 0;
      return sortOrder === 'newest' ? indexB - indexA : indexA - indexB;
    });
    
    // Re-append in sorted order (also moves associated finding-details)
    lines.forEach(line => {
      container.appendChild(line);
      const findingId = line.dataset.findingId;
      if (findingId) {
        const details = document.getElementById(`finding-details-${findingId}`);
        if (details) {
          container.appendChild(details);
        }
      }
    });
  }

  function setLogSort(order) {
    const buttons = document.querySelectorAll('.sort-btn');
    buttons.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.order === order);
    });
    sortLogLines();
  }

  function highlightRegexMatches() {
    // Highlight the regex-matching portion of finding lines
    document.querySelectorAll('.log-line.finding-line').forEach(line => {
      const ruleId = line.dataset.ruleId;
      const textSpan = line.querySelector('.log-line-text');
      if (!ruleId || !textSpan) return;
      
      const originalText = textSpan.textContent || '';
      try {
        const regex = new RegExp(ruleId, 'g');
        let match;
        let lastIndex = 0;
        let html = '';
        let hasMatch = false;
        
        while ((match = regex.exec(originalText)) !== null) {
          const [segment] = match;
          if (!segment) {
            regex.lastIndex += 1;
            continue;
          }
          const start = match.index;
          const end = start + segment.length;
          html += escapeHtml(originalText.slice(lastIndex, start));
          html += `<span class="match-highlight">${escapeHtml(segment)}</span>`;
          lastIndex = end;
          hasMatch = true;
          if (regex.lastIndex === match.index) {
            regex.lastIndex += 1;
          }
        }
        
        if (hasMatch) {
          html += escapeHtml(originalText.slice(lastIndex));
          textSpan.innerHTML = html;
        }
      } catch (err) {
        // Invalid regex, skip highlighting
      }
    });
  }

  // Initialize sort on page load (newest first by default)
  document.addEventListener('DOMContentLoaded', () => {
    setLogSort('newest');
    highlightRegexMatches();
    
    // Add double-click handler for finding lines
    document.querySelectorAll('.log-line.finding-line').forEach(line => {
      line.addEventListener('dblclick', (e) => {
        // Don't trigger if clicking on checkbox or button
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;
        const findingId = line.dataset.findingId;
        if (findingId) {
          toggleFindingDetails(findingId);
        }
      });
    });
  });

  function buildRegexSuggestionFromLine(line) {
    if (!line) return '';
    const escaped = line.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    return escaped.replace(/\\d+/g, '\\\\d+').replace(/[A-Fa-f0-9]{6,}/g, '[A-Fa-f0-9]+');
  }

  function renderFalsePositivePresets() {
    const presetsRoot = document.getElementById('false-positive-presets');
    if (!presetsRoot) return;
    presetsRoot.innerHTML = '';
    const presets = Array.isArray(regexPresets) ? regexPresets : [];
    presets
      .filter(p => !p.kind || p.kind === 'ignore')
      .forEach(preset => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'secondary';
        btn.textContent = preset.name || 'Preset';
        btn.addEventListener('click', () => {
          const field = document.getElementById('false-positive-regex');
          if (!field) return;
          const existing = field.value.trim();
          const addition = preset.pattern || '';
          field.value = existing ? `${existing}${addition}` : addition;
          field.focus();
          testFalsePositiveRegex();
        });
        presetsRoot.appendChild(btn);
      });
  }

  function getSelectionWithin(element) {
    const selection = window.getSelection();
    if (!element || !selection || selection.rangeCount === 0) return '';
    const range = selection.getRangeAt(0);
    const container = range.commonAncestorContainer instanceof Element
      ? range.commonAncestorContainer
      : range.commonAncestorContainer.parentElement;

    if (!container || !element.contains(container)) return '';
    return selection.toString().trim();
  }

  function escapeHtml(text) {
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
    return (text || '').replace(/[&<>"']/g, m => map[m] || m);
  }

  function renderFalsePositiveLine(lineBox, text) {
    if (!lineBox) return;
    lineBox.innerHTML = escapeHtml(text || '');
  }

  function highlightFalsePositiveMatches(lineBox, regex) {
    if (!lineBox) return;
    const lineText = lineBox.dataset.fullLine || '';
    const fallbackText = lineBox.textContent || '';
    const targetText = lineText || fallbackText;
    if (!(regex instanceof RegExp) || !lineText) {
      renderFalsePositiveLine(lineBox, targetText);
      return;
    }

    const flags = regex.flags.includes('g') ? regex.flags : `${regex.flags}g`;
    const globalRe = new RegExp(regex.source, flags);
    let match;
    let cursor = 0;
    let html = '';
    let hasMatch = false;

    while ((match = globalRe.exec(lineText)) !== null) {
      const [segment] = match;
      if (!segment) {
        globalRe.lastIndex += 1;
        continue;
      }
      const start = match.index;
      const end = start + segment.length;
      html += escapeHtml(lineText.slice(cursor, start));
      html += `<span class="match-highlight">${escapeHtml(segment)}</span>`;
      cursor = end;
      hasMatch = true;
      if (globalRe.lastIndex === match.index) {
        globalRe.lastIndex += 1;
      }
    }

    if (!hasMatch) {
      renderFalsePositiveLine(lineBox, lineText);
      return;
    }

    html += escapeHtml(lineText.slice(cursor));
    lineBox.innerHTML = html;
  }

  function useHighlightedTextForRegex() {
    const lineBox = document.getElementById('false-positive-line');
    const regexField = document.getElementById('false-positive-regex');
    const resultBox = document.getElementById('false-positive-test-result');
    if (!lineBox || !regexField) return;

    const selection = getSelectionWithin(lineBox);
    if (!selection) {
      if (resultBox) {
        resultBox.textContent = 'Highlight part of the lines above to build a regex from that selection.';
      }
      return;
    }

    regexField.value = buildRegexSuggestionFromLine(selection);
    regexField.focus();
    if (resultBox) {
      resultBox.textContent = 'Drafted regex from highlighted text. Test to confirm the match.';
    }
    testFalsePositiveRegex();
  }

  function launchFalsePositiveFlow(form) {
    const overlay = document.getElementById('false-positive-overlay');
    const lineBox = document.getElementById('false-positive-line');
    const regexField = document.getElementById('false-positive-regex');
    const testResult = document.getElementById('false-positive-test-result');
    if (!overlay) {
      form?.submit();
      return;
    }
    activeFalsePositiveForm = form;

    const sampleInput = form?.querySelector('input[name="sample_line"]');
    const findingInput = form?.querySelector('input[name="finding_id"]');
    const sampleLine = sampleInput ? sampleInput.value : '';
    const suggestedRegex = buildRegexSuggestionFromLine(sampleLine);

    if (lineBox) {
      lineBox.dataset.fullLine = sampleLine || '';
      renderFalsePositiveLine(lineBox, sampleLine || 'No sample line captured for this finding.');
      lineBox.classList.remove('regex-match');
    }
    if (regexField) {
      regexField.value = suggestedRegex;
    }
    if (testResult) {
      const msg = findingInput?.value
        ? `Finding #${findingInput.value} will be removed after saving.`
        : 'Marking this as false positive will remove the finding.';
      testResult.textContent = msg;
    }

    renderFalsePositivePresets();
    if (overlay) {
      overlay.style.display = 'flex';
      overlay.setAttribute('aria-hidden', 'false');
    }
    setTimeout(() => {
      if (regexField) regexField.focus();
      testFalsePositiveRegex();
    }, 30);
  }

  function closeFalsePositiveFlow() {
    const overlay = document.getElementById('false-positive-overlay');
    const lineBox = document.getElementById('false-positive-line');
    const testResult = document.getElementById('false-positive-test-result');
    activeFalsePositiveForm = null;
    if (overlay) {
      overlay.style.display = 'none';
      overlay.setAttribute('aria-hidden', 'true');
    }
    if (lineBox) {
      renderFalsePositiveLine(lineBox, '');
      lineBox.dataset.fullLine = '';
      lineBox.classList.remove('regex-match');
    }
    if (testResult) {
      testResult.textContent = '';
    }
  }

  function testFalsePositiveRegex() {
    const regexField = document.getElementById('false-positive-regex');
    const lineBox = document.getElementById('false-positive-line');
    const resultBox = document.getElementById('false-positive-test-result');
    if (!regexField || !lineBox || !resultBox) return false;
    const raw = regexField.value.trim();
    const lineText = lineBox.dataset.fullLine || lineBox.textContent || '';
    if (!raw) {
      resultBox.textContent = 'Enter a regex to test against this line.';
      lineBox.classList.remove('regex-match');
      highlightFalsePositiveMatches(lineBox, null);
      return false;
    }
    try {
      const re = new RegExp(raw);
      const matched = re.test(lineText);
      resultBox.textContent = matched
        ? 'Regex matches the line.'
        : 'No match yet—consider generalizing the pattern.';
      lineBox.classList.toggle('regex-match', matched);
      highlightFalsePositiveMatches(lineBox, matched ? re : null);
      return matched;
    } catch (err) {
      resultBox.textContent = err?.message || 'Invalid regex pattern.';
      lineBox.classList.remove('regex-match');
      highlightFalsePositiveMatches(lineBox, null);
      return false;
    }
  }

  function submitFalsePositive() {
    const form = document.getElementById('false-positive-hidden-form');
    const regexField = document.getElementById('false-positive-regex');
    const resultBox = document.getElementById('false-positive-test-result');
    if (!form || !activeFalsePositiveForm) return;
    const regexValue = regexField ? regexField.value.trim() : '';
    if (!regexValue) {
      if (resultBox) resultBox.textContent = 'Add a regex before saving.';
      return;
    }
    const activeInputs = name => activeFalsePositiveForm.querySelector(`input[name="${name}"]`);
    const targetInputs = name => form.querySelector(`input[name="${name}"]`);
    ['finding_id', 'module', 'tail_filter', 'issue_filter', 'sample_source', 'sample_line'].forEach(name => {
      const src = activeInputs(name);
      const dest = targetInputs(name);
      if (dest) {
        dest.value = src ? src.value : dest.value;
      }
    });
    const regexDest = form.querySelector('input[name="regex_value"]');
    if (regexDest) {
      regexDest.value = regexValue;
    }
    form.submit();
  }

  function buildLineLookup() {
    const lookup = new Map();
    document.querySelectorAll('input[name="selected_line"]').forEach(cb => {
      const idxRaw = cb.dataset.lineIndex || cb.value;
      const idx = Number.parseInt(idxRaw, 10);
      const text = cb.dataset.line;
      if (!Number.isNaN(idx) && typeof text !== 'undefined') {
        lookup.set(idx, text);
      }
    });
    return lookup;
  }

  function collectSelectedLines() {
    // Collect selected lines in order by their line index
    const selected = Array.from(document.querySelectorAll('input[name="selected_line"]:checked'));
    const lookup = buildLineLookup();
    
    // Get indexes and sort them
    const entries = selected.map(cb => {
      const idxRaw = cb.dataset.lineIndex || cb.value;
      const idx = Number.parseInt(idxRaw, 10);
      const text = cb.dataset.line;
      return { idx, text };
    }).filter(e => !Number.isNaN(e.idx) || e.text);
    
    // Sort by index
    entries.sort((a, b) => {
      if (Number.isNaN(a.idx)) return 1;
      if (Number.isNaN(b.idx)) return -1;
      return a.idx - b.idx;
    });
    
    return entries.map(e => e.text).filter(Boolean);
  }

  function copyText(text) {
    if (!navigator.clipboard) {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    } else {
      navigator.clipboard.writeText(text);
    }
  }

  function copySelectedLines() {
    const selected = collectSelectedLines();
    copyText(selected.join('\n'));
  }

  async function queryLLMForFinding(findingId) {
    const status = document.getElementById('llm-status');
    const respBox = document.getElementById('llm-response');
    const usage = document.getElementById('llm-usage');
    const citations = document.getElementById('llm-citations');
    
    if (status) status.textContent = 'Querying LLM for finding...';
    respBox.textContent = '';
    if (usage) usage.textContent = '';
    if (citations) citations.textContent = '';

    const formData = new FormData();
    formData.append('finding_id', findingId);
    formData.append('provider', document.getElementById('llm-provider').value);

    try {
      /* eslint-disable */
      const resp = await fetch('{{ url_for("llm_query_finding") }}', { method: 'POST', body: formData });
      /* eslint-enable */
      const responseData = await resp.json();
      
      if (!resp.ok) {
        const errMsg = responseData.error || 'Unknown error';
        if (status) status.textContent = `Error: ${errMsg}`;
        if (respBox) respBox.textContent = errMsg;
        return;
      }

      if (status) status.textContent = `Response from ${responseData.provider} (${responseData.model})`;
      respBox.textContent = responseData.content || '(empty response)';
      
      if (responseData.usage && (responseData.usage.prompt_tokens || responseData.usage.completion_tokens)) {
        if (usage) usage.textContent = `prompt_tokens: ${responseData.usage.prompt_tokens || 'n/a'}, completion_tokens: ${responseData.usage.completion_tokens || 'n/a'}`;
      }
      
      if (responseData.citations && responseData.citations.length > 0) {
        if (citations) citations.textContent = `Citations: ${responseData.citations.join(', ')}`;
      }
      
      lastLLMData = responseData;
    } catch (error) {
      if (status) status.textContent = `Network error: ${error.message}`;
    }
  }

  function refreshSelectedHighlights() {
    document.querySelectorAll('.log-line').forEach(row => {
      const cb = row.querySelector('input[name="selected_line"]');
      row.classList.toggle('selected', cb && cb.checked);
    });
    updateSelectAllButtonLabel();
    updateManualFindingSeed();
  }

  document.querySelectorAll('input[name="selected_line"]').forEach(cb => {
    cb.addEventListener('change', refreshSelectedHighlights);
  });
  refreshSelectedHighlights();

  function toggleSelectAllLines() {
    const boxes = Array.from(document.querySelectorAll('input[name="selected_line"]'));
    if (!boxes.length) return;
    const shouldSelectAll = boxes.some(cb => !cb.checked);
    boxes.forEach(cb => {
      cb.checked = shouldSelectAll;
    });
    refreshSelectedHighlights();
  }

  function updateSelectAllButtonLabel() {
    const btn = document.getElementById('select-all-lines');
    if (!btn) return;
    const boxes = Array.from(document.querySelectorAll('input[name="selected_line"]'));
    if (!boxes.length) {
      btn.textContent = 'Select all';
      return;
    }
    const allChecked = boxes.every(cb => cb.checked);
    btn.textContent = allChecked ? 'Deselect all' : 'Select all';
  }

  function filterLinesBySearch() {
    const searchInput = document.getElementById('fuzzy-search');
    const query = (searchInput?.value || '').toLowerCase().trim();
    
    document.querySelectorAll('.log-line').forEach(line => {
      if (!query) {
        line.style.display = '';
        return;
      }
      const textSpan = line.querySelector('.log-line-text') || line.querySelector('span:last-child');
      const lineText = (textSpan?.textContent || '').toLowerCase();
      // Simple fuzzy match: check if all characters appear in order
      let matchIndex = 0;
      for (const char of query) {
        const foundIndex = lineText.indexOf(char, matchIndex);
        if (foundIndex === -1) {
          line.style.display = 'none';
          return;
        }
        matchIndex = foundIndex + 1;
      }
      line.style.display = '';
    });
  }

  function clearSearch() {
    const searchInput = document.getElementById('fuzzy-search');
    if (searchInput) {
      searchInput.value = '';
      filterLinesBySearch();
    }
  }

  function positionFloatingPanel(panel, trigger) {
    if (!panel || !trigger) return;

    const rect = trigger.getBoundingClientRect();
    const gutter = 8;
    const rightOffset = Math.max(gutter, window.innerWidth - rect.right);

    panel.style.top = `${rect.bottom + gutter}px`;
    panel.style.right = `${rightOffset}px`;
    panel.style.left = 'auto';
  }

  function positionSeverityMenu() {
    positionFloatingPanel(
      document.getElementById('mark-finding-panel'),
      document.getElementById('mark-finding-trigger'),
    );
  }

  function toggleSeverityMenu(forceState = null) {
    const menu = document.getElementById('mark-finding-menu');
    const panel = document.getElementById('mark-finding-panel');
    const trigger = document.getElementById('mark-finding-trigger');
    if (!menu || !panel || !trigger || trigger.disabled) return;
    
    // Check if any selected line is already a finding
    const selectedCheckboxes = Array.from(document.querySelectorAll('input[name="selected_line"]:checked'));
    const hasExistingFinding = selectedCheckboxes.some(cb => cb.dataset.findingId);
    const alreadyFindingMsg = document.getElementById('already-finding-msg');
    const severityButtons = panel.querySelectorAll('button[role="menuitem"]');
    
    if (hasExistingFinding) {
      // Show message, hide severity buttons
      if (alreadyFindingMsg) alreadyFindingMsg.style.display = 'block';
      severityButtons.forEach(btn => btn.style.display = 'none');
    } else {
      // Hide message, show severity buttons
      if (alreadyFindingMsg) alreadyFindingMsg.style.display = 'none';
      severityButtons.forEach(btn => btn.style.display = '');
    }
    
    const shouldOpen = typeof forceState === 'boolean' ? forceState : !menu.classList.contains('open');
    menu.classList.toggle('open', shouldOpen);
    trigger.setAttribute('aria-expanded', shouldOpen ? 'true' : 'false');

    if (shouldOpen) {
      panel.style.display = 'flex';
      positionSeverityMenu();
    } else {
      panel.style.display = 'none';
    }
  }

  function closeSeverityMenu() {
    toggleSeverityMenu(false);
  }

  function positionFindingSeverityMenu(findingId) {
    const panel = document.getElementById(`finding-sev-panel-${findingId}`);
    const trigger = document.getElementById(`finding-sev-trigger-${findingId}`);
    positionFloatingPanel(panel, trigger);
  }

  function toggleFindingSeverityMenu(findingId, forceState = null) {
    const menu = document.getElementById(`finding-sev-menu-${findingId}`);
    const panel = document.getElementById(`finding-sev-panel-${findingId}`);
    const trigger = document.getElementById(`finding-sev-trigger-${findingId}`);
    if (!menu || !panel || !trigger) return;

    const shouldOpen = typeof forceState === 'boolean' ? forceState : !menu.classList.contains('open');
    menu.classList.toggle('open', shouldOpen);
    trigger.setAttribute('aria-expanded', shouldOpen ? 'true' : 'false');

    if (shouldOpen) {
      panel.style.display = 'flex';
      positionFindingSeverityMenu(findingId);
    } else {
      panel.style.display = 'none';
    }
  }

  function closeAllFindingSeverityMenus() {
    document.querySelectorAll('.finding-severity-menu').forEach(menu => {
      const fid = menu.dataset.findingId;
      if (fid) toggleFindingSeverityMenu(fid, false);
    });
  }

  ['scroll', 'resize'].forEach(evt => {
    window.addEventListener(evt, () => {
      const menu = document.getElementById('mark-finding-menu');
      if (menu && menu.classList.contains('open')) {
        positionSeverityMenu();
      }
      document.querySelectorAll('.finding-severity-menu.open').forEach(menu => {
        const fid = menu.dataset.findingId;
        if (fid) positionFindingSeverityMenu(fid);
      });
    }, true);
  });

  function setManualFindingLabel() {
    const label = document.getElementById('mark-finding-label');
    if (label) {
      label.textContent = 'Mark as finding';
    }
  }

  function toggleSection(btn) {
    const idx = btn.dataset.sectionIndex;
    const sections = document.querySelectorAll('.log-section');
    const section = sections[idx];
    if (section) {
      section.classList.toggle('collapsed');
      btn.textContent = section.classList.contains('collapsed') ? 'Expand' : 'Collapse';
    }
  }

  function updateProviderHints() {
    const select = document.getElementById('llm-provider');
    const hints = document.getElementById('provider-hints');
    if (!select || !hints) {
      return;
    }
    const cfg = providerSettings[select.value];
    if (!cfg) {
      hints.textContent = '';
      return;
    }
    hints.textContent = `max_excerpt_lines ${cfg.max_excerpt_lines}, max_tokens ${cfg.max_output_tokens}, temp ${cfg.temperature}, top_p ${cfg.top_p}`;
  }

  async function summarizeAndRecord() {
    const respBox = document.getElementById('llm-response');
    const status = document.getElementById('llm-status');
    const targetFinding = getSelectedFindingId();
    const responseText = respBox ? respBox.textContent.trim() : '';
    if (!responseText) {
      if (status) status.textContent = 'No AI opinion to summarize yet.';
      return;
    }
    const template = typeof summaryPromptTemplate === 'string' && summaryPromptTemplate.trim()
      ? summaryPromptTemplate
      : `Write a short, concise summary that explains the error described in the following AI opinion and how to address it.\n\n${SUMMARY_PLACEHOLDER}`;
    const summaryPrompt = template.includes(SUMMARY_PLACEHOLDER)
      ? template.replace(SUMMARY_PLACEHOLDER, responseText)
      : `${template.trim()}\n\n${responseText}`;
    const data = await callLLM(summaryPrompt);
    if (!data) return;
    if (!targetFinding) {
      if (status) status.textContent = 'Summary created. Select a finding line to record it.';
      return;
    }
    recordedSummaries[targetFinding] = data.content || '';
    const summaryEl = document.querySelector(`[data-summary-for="${targetFinding}"]`);
    if (summaryEl) {
      summaryEl.textContent = `Recorded summary: ${recordedSummaries[targetFinding]}`;
      summaryEl.style.display = 'block';
    }
    await persistOpinionToFinding(targetFinding, data);
    if (status) status.textContent = 'Summary recorded for finding #' + targetFinding;
  }

  function getSelectedFindingIds() {
    const ids = new Set();
    const checked = Array.from(document.querySelectorAll('input[name="selected_line"]:checked'));
    checked.forEach(cb => {
      // First check the checkbox's own data-finding-id attribute
      if (cb.dataset.findingId) {
        ids.add(cb.dataset.findingId);
        return;
      }
      // Fallback: check the parent element with data-finding-section
      const section = cb.closest('[data-finding-section="true"]');
      if (section && section.dataset.findingId) {
        ids.add(section.dataset.findingId);
      }
    });
    return Array.from(ids);
  }

  function getSelectedFindingId() {
    const ids = getSelectedFindingIds();
    return ids.length ? ids[0] : '';
  }

  function deleteSelectedFindings() {
    const form = document.getElementById('delete-selected-findings-form');
    const idsInput = document.getElementById('selected-finding-ids');
    if (!form || !idsInput) return;
    const ids = getSelectedFindingIds();
    if (!ids.length) {
      alert('Select at least one finding entry to delete.');
      return;
    }
    const confirmed = confirm(`Delete ${ids.length} selected finding(s)?`);
    if (!confirmed) return;
    idsInput.value = ids.join(',');
    form.submit();
  }

  async function attachOpinionToSelectedFinding() {
    const status = document.getElementById('llm-status');
    const respBox = document.getElementById('llm-response');
    const targetFinding = getSelectedFindingId();
    const responseText = respBox ? respBox.textContent.trim() : '';
    if (!targetFinding) {
      if (status) status.textContent = 'Select a finding line to attach the AI opinion.';
      return;
    }
    if (!responseText || responseText === 'No AI opinion yet.') {
      if (status) status.textContent = 'Run an AI query before attaching.';
      return;
    }
    recordedSummaries[targetFinding] = responseText;
    const summaryEl = document.querySelector(`[data-summary-for="${targetFinding}"]`);
    if (summaryEl) {
      summaryEl.textContent = `Recorded AI opinion: ${responseText}`;
      summaryEl.style.display = 'block';
    }
    await persistOpinionToFinding(targetFinding, lastLLMData || { content: responseText });
    if (status) status.textContent = 'AI opinion attached to finding #' + targetFinding;
  }

  async function persistOpinionToFinding(findingId, data = {}) {
    const status = document.getElementById('llm-status');
    const payload = new FormData();
    payload.append('finding_id', findingId);
    payload.append('provider', data.provider || '');
    payload.append('model', data.model || '');
    payload.append('content', data.content || '');
    if (data.usage) {
      if (typeof data.usage.prompt_tokens !== 'undefined') {
        payload.append('prompt_tokens', data.usage.prompt_tokens ?? '');
      }
      if (typeof data.usage.completion_tokens !== 'undefined') {
        payload.append('completion_tokens', data.usage.completion_tokens ?? '');
      }
    }

    try {
      /* eslint-disable */
      const resp = await fetch('{{ url_for("record_finding_opinion") }}', { method: 'POST', body: payload });
      /* eslint-enable */
      const dataResp = await resp.json();
      if (!resp.ok) {
        throw new Error(dataResp.error || 'Failed to store AI opinion.');
      }
      if (status) status.textContent = dataResp.message || 'AI opinion stored.';
      return true;
    } catch (err) {
      if (status) status.textContent = err.message || 'Failed to store AI opinion.';
      return false;
    }
  }

  function getSelectedLineData() {
    return Array.from(document.querySelectorAll('input[name="selected_line"]:checked')).map(cb => ({
      index: cb.dataset.lineIndex || cb.value,
      text: cb.dataset.line,
    }));
  }

  function submitManualFinding(severity = null) {
    const form = document.getElementById('manual-finding-form');
    if (!form) return;
    const selected = getSelectedLineData();
    if (!selected.length) {
      alert('Select at least one log line to record a finding.');
      return;
    }
    const lines = selected.map(item => item.text).filter(Boolean);
    if (!lines.length) {
      alert('Selected lines did not include any content.');
      return;
    }
    const severityField = document.getElementById('manual-finding-severity');
    if (severityField && severity) {
      severityField.value = severity;
      setManualFindingLabel();
    }
    const indexes = selected
      .map(item => Number.parseInt(item.index, 10))
      .filter(idx => !Number.isNaN(idx));

    const linesField = document.getElementById('manual-finding-lines');
    const indexesField = document.getElementById('manual-finding-indexes');
    if (linesField) linesField.value = lines.join('\n');
    if (indexesField) indexesField.value = indexes.join(',');
    closeSeverityMenu();
    form.submit();
  }

  function submitFindingSeverity(findingId, severity) {
    const form = document.getElementById(`finding-severity-form-${findingId}`);
    const severityField = document.getElementById(`finding-severity-value-${findingId}`);
    if (!form || !severityField) return;

    if (severity) {
      severityField.value = severity;
    }
    closeAllFindingSeverityMenus();
    form.submit();
  }

  function updateManualFindingSeed() {
    setManualFindingLabel();
  }

  document.addEventListener('click', event => {
    const markMenu = document.getElementById('mark-finding-menu');
    if (markMenu && !markMenu.contains(event.target)) {
      closeSeverityMenu();
    }

    const findingMenu = event.target.closest('.finding-severity-menu');
    if (!findingMenu) {
      closeAllFindingSeverityMenus();
    }
  });

  document.addEventListener('keydown', event => {
    if (event.key === 'Escape') {
      closeSeverityMenu();
      closeAllFindingSeverityMenus();
      closeFalsePositiveFlow();
    }
  });

  updateManualFindingSeed();

  updateProviderHints();
  const providerSelect = document.getElementById('llm-provider');
  if (providerSelect) {
    providerSelect.addEventListener('change', updateProviderHints);
  }
</script>
{% endblock %}
